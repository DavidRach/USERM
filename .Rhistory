df_pos = tmp_ssm_obj$df_pos
##check columns of df_pos
detector_pos = colnames(df_pos)
missing_cols <- setdiff(detector_pos, detector_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following detectors are missing from df_pos in the ssm obj of ",fluor ,":",
paste(missing_cols, collapse = ", ")))
}else{
df_pos = df_pos[,detector_A]
}
df_neg = tmp_ssm_obj$df_neg
##check columns of df_neg
detector_neg = colnames(df_neg)
missing_cols <- setdiff(detector_neg, detector_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following detectors are missing from df_neg in the ssm obj of ",fluor ,":",
paste(missing_cols, collapse = ", ")))
}else{
df_neg = df_neg[,detector_A]
}
# unmix
R_pos = t(df_pos) #R (detectors x cells)
B_pos =  A_pinv %*% R_pos #B (fluors x cells)
B_pos = t(B_pos)
colnames(B_pos) = fluor_A
R_neg = t(df_neg) #R (detectors x cells)
B_neg =  A_pinv %*% R_neg #B (fluors x cells)
B_neg = t(B_neg)
colnames(B_neg) = fluor_A
#calculate ss
fluor_negchannel = f_neg
if(fluor_negchannel == fluor){
R_F_neg_84 = NA
R_F_neg_50 = NA
R_sigma_F_neg = NA
S_F_neg_84 = NA
S_F_neg_50 = NA
S_sigma_F_neg = NA
S_F_pos_50 = NA
R_F_pos_50 = NA
delta_F_pos = NA
delta_sigma_F_neg_2 = NA
ss_2 = NA
ss = 0
}else{
R_F_neg_84 = quantile(B_neg[,fluor_negchannel],probs = 0.84)[[1]]
R_F_neg_50 = quantile(B_neg[,fluor_negchannel],probs = 0.50)[[1]]
R_sigma_F_neg = R_F_neg_84 - R_F_neg_50
S_F_neg_84 = quantile(B_pos[,fluor_negchannel],probs = 0.84)[[1]]
S_F_neg_50 = quantile(B_pos[,fluor_negchannel],probs = 0.50)[[1]]
S_sigma_F_neg = S_F_neg_84 - S_F_neg_50
S_F_pos_50 = quantile(B_pos[,fluor],probs = 0.50)[[1]]
R_F_pos_50 = quantile(B_neg[,fluor],probs = 0.50)[[1]]
delta_F_pos = S_F_pos_50 - R_F_pos_50
delta_sigma_F_neg_2 = S_sigma_F_neg^2 - R_sigma_F_neg^2
if(delta_F_pos == 0){
ss_2 = NA
ss = NA
}else{
ss_2 = delta_sigma_F_neg_2 / delta_F_pos
if(ss_2 < 0){
ss = - sqrt(-ss_2)
}else{
ss = sqrt(ss_2)
}
}
}
return(list(B_pos = B_pos,
B_neg = B_neg,
R_F_neg_84 = R_F_neg_84,
R_F_neg_50 = R_F_neg_50,
R_sigma_F_neg = R_sigma_F_neg,
S_F_neg_84 = S_F_neg_84,
S_F_neg_50 = S_F_neg_50,
S_sigma_F_neg = S_sigma_F_neg,
S_F_pos_50 = S_F_pos_50,
R_F_pos_50 = R_F_pos_50,
delta_F_pos = delta_F_pos,
delta_sigma_F_neg_2 = delta_sigma_F_neg_2,
ss_2 = ss_2,
ss = ss))
}
ss_output = check_ss(f_pos = "SCC3_Cell_BV510_CD4",
f_neg = "SCC3_Cell_BUV395_CD4",
SSM_fluor = UsermObj$fluors[1:20],
A = UsermObj$A,
custom_ssm_dir = "E:/MyFolder/ssm")
View(ss_output)
View(ssm)
check_ss = function(f_pos, f_neg, SSM_fluor,A,custom_ssm_dir = NULL){
#prepare A
detector_A = rownames(A)
fluor_A = colnames(A)
A_pinv = ginv(A)
#check if all SSM_fluor has corresponding data in ssm folder
## find available ssm_file from USERM
all_ssm_file_builtin = list.files(system.file("ssm", package = "USERM"))
all_ssm_file_builtin = sub("^SSMObj_", "", sub("\\.rds$", "", all_ssm_file_builtin))
## find available ssm_file from custom_ssm_dir
if(is.null(custom_ssm_dir)){
all_ssm_file_custom = c()
}else{
all_ssm_file_custom = dir(custom_ssm_dir)
all_ssm_file_custom = sub("^SSMObj_", "", sub("\\.rds$", "", all_ssm_file_custom))
}
## check SSM_fluor availability
missing_cols <- setdiff(SSM_fluor, c(all_ssm_file_builtin,all_ssm_file_custom))
if (length(missing_cols) > 0) {
stop(paste("Error: The following required fluors are missing from USERM and custom dir:",
paste(missing_cols, collapse = ", ")))
}
#check if all SSM_fluor are in A
missing_cols <- setdiff(SSM_fluor, fluor_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following required fluors are missing from input A:",
paste(missing_cols, collapse = ", ")))
}
#calculate ss
fluor = f_pos
print(fluor)
# load ssmobj
if(fluor %in% all_ssm_file_builtin){
tmp_ssm_obj = readRDS(system.file("ssm", paste0("SSMObj_",fluor,".rds"), package = "USERM"))
}else{
tmp_ssm_obj = readRDS(paste0(custom_ssm_dir,"/SSMObj_",fluor,".rds"))
}
#check df_pos and df_neg
df_pos = tmp_ssm_obj$df_pos
##check columns of df_pos
detector_pos = colnames(df_pos)
missing_cols <- setdiff(detector_pos, detector_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following detectors are missing from df_pos in the ssm obj of ",fluor ,":",
paste(missing_cols, collapse = ", ")))
}else{
df_pos = df_pos[,detector_A]
}
df_neg = tmp_ssm_obj$df_neg
##check columns of df_neg
detector_neg = colnames(df_neg)
missing_cols <- setdiff(detector_neg, detector_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following detectors are missing from df_neg in the ssm obj of ",fluor ,":",
paste(missing_cols, collapse = ", ")))
}else{
df_neg = df_neg[,detector_A]
}
# unmix
R_pos = t(df_pos) #R (detectors x cells)
B_pos =  A_pinv %*% R_pos #B (fluors x cells)
B_pos = t(B_pos)
colnames(B_pos) = fluor_A
R_neg = t(df_neg) #R (detectors x cells)
B_neg =  A_pinv %*% R_neg #B (fluors x cells)
B_neg = t(B_neg)
colnames(B_neg) = fluor_A
#calculate ss
fluor_negchannel = f_neg
if(fluor_negchannel == fluor){
R_F_neg_84 = NA
R_F_neg_50 = NA
R_sigma_F_neg = NA
S_F_neg_84 = NA
S_F_neg_50 = NA
S_sigma_F_neg = NA
S_F_pos_50 = NA
R_F_pos_50 = NA
delta_F_pos = NA
delta_sigma_F_neg_2 = NA
ss_2 = NA
ss = 0
}else{
R_F_neg_84 = quantile(B_neg[,fluor_negchannel],probs = 0.84)[[1]]
R_F_neg_50 = quantile(B_neg[,fluor_negchannel],probs = 0.50)[[1]]
R_sigma_F_neg = R_F_neg_84 - R_F_neg_50
S_F_neg_84 = quantile(B_pos[,fluor_negchannel],probs = 0.84)[[1]]
S_F_neg_50 = quantile(B_pos[,fluor_negchannel],probs = 0.50)[[1]]
S_sigma_F_neg = S_F_neg_84 - S_F_neg_50
S_F_pos_50 = quantile(B_pos[,fluor],probs = 0.50)[[1]]
R_F_pos_50 = quantile(B_neg[,fluor],probs = 0.50)[[1]]
delta_F_pos = S_F_pos_50 - R_F_pos_50
delta_sigma_F_neg_2 = S_sigma_F_neg^2 - R_sigma_F_neg^2
if(delta_F_pos == 0){
ss_2 = NA
ss = NA
}else{
ss_2 = delta_sigma_F_neg_2 / delta_F_pos
if(ss_2 < 0){
ss = - sqrt(-ss_2)
}else{
ss = sqrt(ss_2)
}
}
}
return(list(f_pos = f_pos,
f_neg = f_neg,
B_pos = B_pos,
B_neg = B_neg,
R_F_neg_84 = R_F_neg_84,
R_F_neg_50 = R_F_neg_50,
R_sigma_F_neg = R_sigma_F_neg,
S_F_neg_84 = S_F_neg_84,
S_F_neg_50 = S_F_neg_50,
S_sigma_F_neg = S_sigma_F_neg,
S_F_pos_50 = S_F_pos_50,
R_F_pos_50 = R_F_pos_50,
delta_F_pos = delta_F_pos,
delta_sigma_F_neg_2 = delta_sigma_F_neg_2,
ss_2 = ss_2,
ss = ss))
}
ss_output = check_ss(f_pos = "SCC3_Cell_BV510_CD4",
f_neg = "SCC3_Cell_BUV395_CD4",
SSM_fluor = UsermObj$fluors[1:20],
A = UsermObj$A,
custom_ssm_dir = "E:/MyFolder/ssm")
plot_df_pos = ss_output$B_pos[,c(ss_output$f_pos,ss_output$f_neg)]
View(plot_df_pos)
plot_df_pos = ss_output$B_pos[,c(ss_output$f_pos,ss_output$f_neg)]
plot_df_pos$group = "Stain"
plot_df_neg = ss_output$B_neg[,c(ss_output$f_pos,ss_output$f_neg)]
plot_df_neg$group = "Reference"
plot_df_pos = as.data.frame(ss_output$B_pos[,c(ss_output$f_pos,ss_output$f_neg)])
plot_df_pos$group = "Stain"
View(data_pos)
View(plot_df_pos)
plot_df_pos = as.data.frame(ss_output$B_pos[,c(ss_output$f_pos,ss_output$f_neg)])
plot_df_pos$group = "Stain"
plot_df_neg = as.data.frame(ss_output$B_neg[,c(ss_output$f_pos,ss_output$f_neg)])
plot_df_neg$group = "Reference"
plot_df = rbind(plot_df_pos,plot_df_neg)
colnames(plot_df) = c("x","y","group")
ggplot(plot_df,
aes(x = x,
y = y,
col = group)) +
geom_point()
ggplot(plot_df, aes(x = x,y = y,col = group)) +
geom_point()+
xlab(ss_output$f_pos) + # Label for X-axis
ylab(ss_output$f_neg) + # Label for Y-axis
theme_minimal() # Apply minimal theme
ggplot(plot_df, aes(x = x,y = y,col = group)) +
geom_point()+
xlab(ss_output$f_pos) + # Label for X-axis
ylab(ss_output$f_neg) + # Label for Y-axis
theme_classic() # Apply minimal theme
ggplot(plot_df, aes(x = x,y = y,col = group)) +
geom_point()+
xlab(ss_output$f_pos) + # Label for X-axis
ylab(ss_output$f_neg) + # Label for Y-axis
theme_bw() # Apply minimal theme
vis_ss_scatter = function(ss_output){
plot_df_pos = as.data.frame(ss_output$B_pos[,c(ss_output$f_pos,ss_output$f_neg)])
plot_df_pos$group = "Stain"
plot_df_neg = as.data.frame(ss_output$B_neg[,c(ss_output$f_pos,ss_output$f_neg)])
plot_df_neg$group = "Reference"
plot_df = rbind(plot_df_pos,plot_df_neg)
colnames(plot_df) = c("x","y","group")
ggplot(plot_df, aes(x = x,y = y,col = group)) +
geom_point()+
xlab(ss_output$f_pos) + # Label for X-axis
ylab(ss_output$f_neg) + # Label for Y-axis
theme_bw()
}
vis_ss_scatter(ss_output)
vis_ss_scatter(ss_output)
EstimateSSM = function(SSM_fluor,A,custom_ssm_dir = NULL){
#prepare A
detector_A = rownames(A)
fluor_A = colnames(A)
A_pinv = ginv(A)
#check if all SSM_fluor has corresponding data in ssm folder
## find available ssm_file from USERM
all_ssm_file_builtin = list.files(system.file("ssm", package = "USERM"))
all_ssm_file_builtin = sub("^SSMObj_", "", sub("\\.rds$", "", all_ssm_file_builtin))
## find available ssm_file from custom_ssm_dir
if(is.null(custom_ssm_dir)){
all_ssm_file_custom = c()
}else{
all_ssm_file_custom = dir(custom_ssm_dir)
all_ssm_file_custom = sub("^SSMObj_", "", sub("\\.rds$", "", all_ssm_file_custom))
}
## check SSM_fluor availability
missing_cols <- setdiff(SSM_fluor, c(all_ssm_file_builtin,all_ssm_file_custom))
if (length(missing_cols) > 0) {
stop(paste("Error: The following required fluors are missing from USERM and custom dir:",
paste(missing_cols, collapse = ", ")))
}
#check if all SSM_fluor are in A
missing_cols <- setdiff(SSM_fluor, fluor_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following required fluors are missing from input A:",
paste(missing_cols, collapse = ", ")))
}
#create empty ssm
ssm = matrix(nrow = length(SSM_fluor), ncol = length(SSM_fluor), dimnames = list(SSM_fluor,SSM_fluor))
for (fluor in SSM_fluor) {
# fluor = SSM_fluor[2]
print(fluor)
# load ssmobj
if(fluor %in% all_ssm_file_builtin){
tmp_ssm_obj = readRDS(system.file("ssm", paste0("SSMObj_",fluor,".rds"), package = "USERM"))
}else{
tmp_ssm_obj = readRDS(paste0(custom_ssm_dir,"/SSMObj_",fluor,".rds"))
}
#check df_pos and df_neg
df_pos = tmp_ssm_obj$df_pos
##check columns of df_pos
detector_pos = colnames(df_pos)
missing_cols <- setdiff(detector_pos, detector_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following detectors are missing from df_pos in the ssm obj of ",fluor ,":",
paste(missing_cols, collapse = ", ")))
}else{
df_pos = df_pos[,detector_A]
}
df_neg = tmp_ssm_obj$df_neg
##check columns of df_neg
detector_neg = colnames(df_neg)
missing_cols <- setdiff(detector_neg, detector_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following detectors are missing from df_neg in the ssm obj of ",fluor ,":",
paste(missing_cols, collapse = ", ")))
}else{
df_neg = df_neg[,detector_A]
}
# unmix
R_pos = t(df_pos) #R (detectors x cells)
B_pos =  A_pinv %*% R_pos #B (fluors x cells)
B_pos = t(B_pos)
colnames(B_pos) = fluor_A
R_neg = t(df_neg) #R (detectors x cells)
B_neg =  A_pinv %*% R_neg #B (fluors x cells)
B_neg = t(B_neg)
colnames(B_neg) = fluor_A
#calculate ss
for(fluor_negchannel in SSM_fluor){
# fluor_negchannel = SSM_fluor[1]
if(fluor_negchannel == fluor){
ssm[fluor,fluor_negchannel] = 0
}else{
R_F_neg_84 = quantile(B_neg[,fluor_negchannel],probs = 0.84)[[1]]
R_F_neg_50 = quantile(B_neg[,fluor_negchannel],probs = 0.50)[[1]]
R_sigma_F_neg = R_F_neg_84 - R_F_neg_50
S_F_neg_84 = quantile(B_pos[,fluor_negchannel],probs = 0.84)[[1]]
S_F_neg_50 = quantile(B_pos[,fluor_negchannel],probs = 0.50)[[1]]
S_sigma_F_neg = S_F_neg_84 - S_F_neg_50
S_F_pos_50 = quantile(B_pos[,fluor],probs = 0.50)[[1]]
R_F_pos_50 = quantile(B_neg[,fluor],probs = 0.50)[[1]]
delta_F_pos = S_F_pos_50 - R_F_pos_50
delta_sigma_F_neg_2 = S_sigma_F_neg^2 - R_sigma_F_neg^2
if(delta_F_pos == 0){
ss = NA
}else{
ss_2 = delta_sigma_F_neg_2 / delta_F_pos
if(ss_2 < 0){
ss = - sqrt(-ss_2)
}else{
ss = sqrt(ss_2)
}
}
ssm[fluor,fluor_negchannel] = ss
}
}
}
return(ssm)
}
ssm = EstimateSSM(SSM_fluor = UsermObj$fluors[1:20],
A = UsermObj$A,
custom_ssm_dir = "E:/MyFolder/ssm")
ss_output = check_ss(f_pos = "SCC3_Cell_BUV395_CD4",
f_neg = "SCC3_Cell_LDBlue_LD",
SSM_fluor = UsermObj$fluors[1:20],
A = UsermObj$A,
custom_ssm_dir = "E:/MyFolder/ssm")
check_ss = function(f_pos, f_neg, SSM_fluor,A,custom_ssm_dir = NULL){
#prepare A
detector_A = rownames(A)
fluor_A = colnames(A)
A_pinv = ginv(A)
#check if all SSM_fluor has corresponding data in ssm folder
## find available ssm_file from USERM
all_ssm_file_builtin = list.files(system.file("ssm", package = "USERM"))
all_ssm_file_builtin = sub("^SSMObj_", "", sub("\\.rds$", "", all_ssm_file_builtin))
## find available ssm_file from custom_ssm_dir
if(is.null(custom_ssm_dir)){
all_ssm_file_custom = c()
}else{
all_ssm_file_custom = dir(custom_ssm_dir)
all_ssm_file_custom = sub("^SSMObj_", "", sub("\\.rds$", "", all_ssm_file_custom))
}
## check SSM_fluor availability
missing_cols <- setdiff(SSM_fluor, c(all_ssm_file_builtin,all_ssm_file_custom))
if (length(missing_cols) > 0) {
stop(paste("Error: The following required fluors are missing from USERM and custom dir:",
paste(missing_cols, collapse = ", ")))
}
#check if all SSM_fluor are in A
missing_cols <- setdiff(SSM_fluor, fluor_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following required fluors are missing from input A:",
paste(missing_cols, collapse = ", ")))
}
#calculate ss
fluor = f_pos
# print(fluor)
# load ssmobj
if(fluor %in% all_ssm_file_builtin){
tmp_ssm_obj = readRDS(system.file("ssm", paste0("SSMObj_",fluor,".rds"), package = "USERM"))
}else{
tmp_ssm_obj = readRDS(paste0(custom_ssm_dir,"/SSMObj_",fluor,".rds"))
}
#check df_pos and df_neg
df_pos = tmp_ssm_obj$df_pos
##check columns of df_pos
detector_pos = colnames(df_pos)
missing_cols <- setdiff(detector_pos, detector_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following detectors are missing from df_pos in the ssm obj of ",fluor ,":",
paste(missing_cols, collapse = ", ")))
}else{
df_pos = df_pos[,detector_A]
}
df_neg = tmp_ssm_obj$df_neg
##check columns of df_neg
detector_neg = colnames(df_neg)
missing_cols <- setdiff(detector_neg, detector_A)
if (length(missing_cols) > 0) {
stop(paste("Error: The following detectors are missing from df_neg in the ssm obj of ",fluor ,":",
paste(missing_cols, collapse = ", ")))
}else{
df_neg = df_neg[,detector_A]
}
# unmix
R_pos = t(df_pos) #R (detectors x cells)
B_pos =  A_pinv %*% R_pos #B (fluors x cells)
B_pos = t(B_pos)
colnames(B_pos) = fluor_A
R_neg = t(df_neg) #R (detectors x cells)
B_neg =  A_pinv %*% R_neg #B (fluors x cells)
B_neg = t(B_neg)
colnames(B_neg) = fluor_A
#calculate ss
fluor_negchannel = f_neg
if(fluor_negchannel == fluor){
R_F_neg_84 = NA
R_F_neg_50 = NA
R_sigma_F_neg = NA
S_F_neg_84 = NA
S_F_neg_50 = NA
S_sigma_F_neg = NA
S_F_pos_50 = NA
R_F_pos_50 = NA
delta_F_pos = NA
delta_sigma_F_neg_2 = NA
ss_2 = NA
ss = 0
}else{
R_F_neg_84 = quantile(B_neg[,fluor_negchannel],probs = 0.84)[[1]]
R_F_neg_50 = quantile(B_neg[,fluor_negchannel],probs = 0.50)[[1]]
R_sigma_F_neg = R_F_neg_84 - R_F_neg_50
S_F_neg_84 = quantile(B_pos[,fluor_negchannel],probs = 0.84)[[1]]
S_F_neg_50 = quantile(B_pos[,fluor_negchannel],probs = 0.50)[[1]]
S_sigma_F_neg = S_F_neg_84 - S_F_neg_50
S_F_pos_50 = quantile(B_pos[,fluor],probs = 0.50)[[1]]
R_F_pos_50 = quantile(B_neg[,fluor],probs = 0.50)[[1]]
delta_F_pos = S_F_pos_50 - R_F_pos_50
delta_sigma_F_neg_2 = S_sigma_F_neg^2 - R_sigma_F_neg^2
if(delta_F_pos == 0){
ss_2 = NA
ss = NA
}else{
ss_2 = delta_sigma_F_neg_2 / delta_F_pos
if(ss_2 < 0){
ss = - sqrt(-ss_2)
}else{
ss = sqrt(ss_2)
}
}
}
return(list(f_pos = f_pos,
f_neg = f_neg,
B_pos = B_pos,
B_neg = B_neg,
R_F_neg_84 = R_F_neg_84,
R_F_neg_50 = R_F_neg_50,
R_sigma_F_neg = R_sigma_F_neg,
S_F_neg_84 = S_F_neg_84,
S_F_neg_50 = S_F_neg_50,
S_sigma_F_neg = S_sigma_F_neg,
S_F_pos_50 = S_F_pos_50,
R_F_pos_50 = R_F_pos_50,
delta_F_pos = delta_F_pos,
delta_sigma_F_neg_2 = delta_sigma_F_neg_2,
ss_2 = ss_2,
ss = ss))
}
ss_output = check_ss(f_pos = "SCC3_Cell_BUV395_CD4",
f_neg = "SCC3_Cell_LDBlue_LD",
SSM_fluor = UsermObj$fluors[1:20],
A = UsermObj$A,
custom_ssm_dir = "E:/MyFolder/ssm")
vis_ss_scatter(ss_output)
max(ssm)
ss_output = check_ss(f_pos = "SCC3_Cell_BUV805_CD4",
f_neg = "SCC3_Cell_BUV737_CD4",
SSM_fluor = UsermObj$fluors[1:20],
A = UsermObj$A,
custom_ssm_dir = "E:/MyFolder/ssm")
vis_ss_scatter(ss_output)
devtools::document()

saveRDS(Sig_list, file = paste0(tmp_dir,"/Sig_list.rds"))
# SCC_Bead_TCRVa72_FITC ####
data = read.FCS(paste0(data_dir,"/20250902 XICAI_NK_MulticolorTest_05/SCC_Beads_TCRVa72_FITC Run 1 20250903085648.fcs"))
peak_channel = '488nm - 520/40-A'
subpeak_channel = '349nm - 387/11-A'
save_suf = "SCC_Bead_TCRVa72_FITC"
PrimaryName = "TCRVa72"
SecondaryName = "FITC"
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
nrow(data)
#gate first if need
data$gate0 = TRUE
data = sample_n(data, 20000)
#gate singlets
gate1<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 FSC-H", feature_col= "488 FSC-A",
parentgate_col= "gate0", newgate_col= "gate1",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate1, df = data)
gate2<-PolygonGating(df=data, x_col= "488 SSC-A", y_col= "488 SSC-H", feature_col= "488 SSC-A",
parentgate_col= "gate1", newgate_col= "gate2",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate2, df = data)
gate3<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 SSC-A", feature_col= "488 SSC-A",
parentgate_col= "gate2", newgate_col= "gate3",canvas_width=2000, canvas_height=2000)
gate3<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 SSC-A", feature_col= "488 SSC-A",
parentgate_col= "gate2", newgate_col= "gate3",canvas_width=2000, canvas_height=2000)
data <-GateDecider(gate = gate3, df = data)
data = data[data$gate3,]
gate_pos<-PolygonGating(df=data, x_col= peak_channel, y_col= subpeak_channel, feature_col= peak_channel,
parentgate_col= "gate3", newgate_col= "gate_pos",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate_pos, df = data)
gate_neg<-PolygonGating(df=data, x_col= peak_channel, y_col= subpeak_channel, feature_col= peak_channel,
parentgate_col= "gate3", newgate_col= "gate_neg",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate_neg, df = data)
table(data$gate_pos)
table(data$gate_neg)
data_pos = data[data$gate_pos,]
data_neg = data[data$gate_neg,]
saveRDS(list(gate1,gate2,gate3,gate_pos,gate_neg), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate1","gate2","gate3","gate_pos","gate_neg"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
Sig = ExtractSig(df_pos = data_pos,df_neg = data_neg,
cols = cols, method = "median",
PrimaryName = PrimaryName,
SecondaryName = SecondaryName,
id = save_suf,
instrument = "Xenith",
Source = "XiangmingCai",
Note = NA)
df <- data.frame(Detector = names(Sig$Signature),Signal = as.numeric(Sig$Signature))
ggplot(df, aes(x = Detector, y = Signal, group = 1)) +
geom_line(color = "steelblue", size = 1) +
geom_point(color = "darkred", size = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(title = save_suf,
x = "Detector",
y = "Signal")
# Sig_list[[length(Sig_list)]] = NULL
# Sig_list[[63]] = Sig #AF
Sig_list = readRDS(paste0(tmp_dir,"/Sig_list.rds"))
Sig_list[[length(Sig_list)+1]] = Sig
names(Sig_list)[length(Sig_list)] = Sig_list[[length(Sig_list)]]$id
saveRDS(Sig_list, file = paste0(tmp_dir,"/Sig_list.rds"))
# merge sig df ####
# for (i in 1:65) {
#   Sig_list[[i]]$Source = "XiangmingCai"
#   Sig_list[[i]]$Note = NA
# }
names(Sig_list)
# Sig_list$SCC2_Cell_BV421_CD4$Signature = Sig_list$SCC2_Cell_BV421_CD4$Signature[names(Sig_list$SCC_Bead_CD4_NFR700$Signature)]
Sig_df = SigList2df(SigList= Sig_list[c(1:63,202:205)],SigName = "id")
# Sig_df = SigList2df(SigList= Sig_list[1:137],SigName = "id")
# Sig_df = SigList2df(SigList= Sig_list[138:201],SigName = "id")
Sig_mtx = as.matrix(Sig_df)
colnames(Sig_mtx)
# SCC_Bead_CD2_SB780 ####
data = read.FCS(paste0(data_dir,"/20250902 XICAI_NK_MulticolorTest_05/SCC_Beads_CD2_SB780 Run 1 20250903085138.fcs"))
peak_channel = '405nm - 770/LP-A'
subpeak_channel = '349nm - 387/11-A'
save_suf = "SCC_Bead_CD2_SB780"
#SCC_Bead_CD2_SB780 ####
data = read.FCS(paste0(data_dir,"/20250902 XICAI_NK_MulticolorTest_05/SCC_Beads_CD2_SB780 Run 1 20250903085138.fcs"))
save_suf = "SCC_Bead_CD2_SB780"
idx_target_fluor = 64
idx_AF_fluor = 4
#RES internal####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
colnames(data)
#gate clean data for estimation
#gate singlets
data$gate0 = TRUE
data_backup = data
gate1<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 FSC-H", feature_col= "488 FSC-A",
parentgate_col= "gate0", newgate_col= "gate1",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate1, df = data)
gate2<-PolygonGating(df=data, x_col= "488 SSC-A", y_col= "488 SSC-H", feature_col= "488 SSC-A",
parentgate_col= "gate1", newgate_col= "gate2",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate2, df = data)
gate3<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 SSC-A", feature_col= "488 SSC-A",
parentgate_col= "gate2", newgate_col= "gate3",canvas_width=2000, canvas_height=2000)
data <-GateDecider(gate = gate3, df = data)
data = data_backup
data <-GateDecider(gate = gate1, df = data)
data <-GateDecider(gate = gate2, df = data)
data <-GateDecider(gate = gate3, df = data)
data = data[data$gate3,]
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.999)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]
data_backup = data
# data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.5999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 10,height = 10)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
df <- data.frame(Detector = rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE]),
Signal = as.numeric(Sig_mtx[,c(idx_target_fluor), drop = FALSE]))
ggplot(df, aes(x = Detector, y = Signal, group = 1)) +
geom_line(color = "steelblue", size = 1) +
geom_point(color = "darkred", size = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(title = save_suf,
x = "Detector",
y = "Signal")
dev.off()
data = read.FCS(paste0(data_dir,"/20250902 XICAI_NK_MulticolorTest_05/SCC_Beads_CRTH2_PEVio670 Run 1 20250903084848.fcs"))
save_suf = "SCC_Bead_CRTH2_PEVio670"
idx_target_fluor = 65
idx_AF_fluor = 4
#RES internal####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
{
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
colnames(data)
#gate clean data for estimation
#gate singlets
data$gate0 = TRUE
data_backup = data
# data = sample_n(data, 20000)
}
gate1<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 FSC-H", feature_col= "488 FSC-A",
parentgate_col= "gate0", newgate_col= "gate1",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate1, df = data)
gate2<-PolygonGating(df=data, x_col= "488 SSC-A", y_col= "488 SSC-H", feature_col= "488 SSC-A",
parentgate_col= "gate1", newgate_col= "gate2",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate2, df = data)
gate3<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 SSC-A", feature_col= "488 SSC-A",
parentgate_col= "gate2", newgate_col= "gate3",canvas_width=2000, canvas_height=2000)
data <-GateDecider(gate = gate3, df = data)
{
data = data_backup
data <-GateDecider(gate = gate1, df = data)
data <-GateDecider(gate = gate2, df = data)
data <-GateDecider(gate = gate3, df = data)
data = data[data$gate3,]
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.999)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]
}
data_backup = data
# data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.5999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 10,height = 10)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
df <- data.frame(Detector = rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE]),
Signal = as.numeric(Sig_mtx[,c(idx_target_fluor), drop = FALSE]))
ggplot(df, aes(x = Detector, y = Signal, group = 1)) +
geom_line(color = "steelblue", size = 1) +
geom_point(color = "darkred", size = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(title = save_suf,
x = "Detector",
y = "Signal")
data = read.FCS(paste0(data_dir,"/20250902 XICAI_NK_MulticolorTest_05/SCC_Beads_TCRgd_PerCPef710 Run 1 20250903085510.fcs"))
save_suf = "SCC_Bead_TCRgd_PerCPef710"
idx_target_fluor = 66
idx_AF_fluor = 4
#RES internal####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
{
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
colnames(data)
#gate clean data for estimation
#gate singlets
data$gate0 = TRUE
data_backup = data
# data = sample_n(data, 20000)
}
gate1<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 FSC-H", feature_col= "488 FSC-A",
parentgate_col= "gate0", newgate_col= "gate1",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate1, df = data)
gate2<-PolygonGating(df=data, x_col= "488 SSC-A", y_col= "488 SSC-H", feature_col= "488 SSC-A",
parentgate_col= "gate1", newgate_col= "gate2",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate2, df = data)
gate3<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 SSC-A", feature_col= "488 SSC-A",
parentgate_col= "gate2", newgate_col= "gate3",canvas_width=2000, canvas_height=2000)
data <-GateDecider(gate = gate3, df = data)
{
data = data_backup
data <-GateDecider(gate = gate1, df = data)
data <-GateDecider(gate = gate2, df = data)
data <-GateDecider(gate = gate3, df = data)
data = data[data$gate3,]
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.999)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]
}
data_backup = data
# data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.5999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 10,height = 10)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
dev.off()
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 10,height = 10)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
data = read.FCS(paste0(data_dir,"/20250902 XICAI_NK_MulticolorTest_05/SCC_Beads_TCRVa24Ja18_APC Run 1 20250903085335.fcs"))
save_suf = "SCC_Bead_TCRVa24Ja18_APC"
idx_target_fluor = 67
idx_AF_fluor = 4
#RES internal####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
{
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
colnames(data)
#gate clean data for estimation
#gate singlets
data$gate0 = TRUE
data_backup = data
# data = sample_n(data, 20000)
}
gate1<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 FSC-H", feature_col= "488 FSC-A",
parentgate_col= "gate0", newgate_col= "gate1",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate1, df = data)
gate2<-PolygonGating(df=data, x_col= "488 SSC-A", y_col= "488 SSC-H", feature_col= "488 SSC-A",
parentgate_col= "gate1", newgate_col= "gate2",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate2, df = data)
gate3<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 SSC-A", feature_col= "488 SSC-A",
parentgate_col= "gate2", newgate_col= "gate3",canvas_width=2000, canvas_height=2000)
data <-GateDecider(gate = gate3, df = data)
{
data = data_backup
data <-GateDecider(gate = gate1, df = data)
data <-GateDecider(gate = gate2, df = data)
data <-GateDecider(gate = gate3, df = data)
data = data[data$gate3,]
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.999)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]
}
data_backup = data
# data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.5999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 10,height = 10)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
data = read.FCS(paste0(data_dir,"/20250902 XICAI_NK_MulticolorTest_05/SCC_Beads_TCRVa72_FITC Run 1 20250903085648.fcs"))
save_suf = "SCC_Bead_TCRVa72_FITC"
idx_target_fluor = 68
idx_AF_fluor = 4
data = read.FCS(paste0(data_dir,"/20250902 XICAI_NK_MulticolorTest_05/SCC_Beads_TCRVa72_FITC Run 1 20250903085648.fcs"))
save_suf = "SCC_Bead_TCRVa72_FITC"
idx_target_fluor = 68
idx_AF_fluor = 4
#RES internal####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)
# merge sig df ####
# for (i in 1:65) {
#   Sig_list[[i]]$Source = "XiangmingCai"
#   Sig_list[[i]]$Note = NA
# }
names(Sig_list)
# Sig_list$SCC2_Cell_BV421_CD4$Signature = Sig_list$SCC2_Cell_BV421_CD4$Signature[names(Sig_list$SCC_Bead_CD4_NFR700$Signature)]
Sig_df = SigList2df(SigList= Sig_list[c(1:63,202:206)],SigName = "id")
# Sig_df = SigList2df(SigList= Sig_list[1:137],SigName = "id")
# Sig_df = SigList2df(SigList= Sig_list[138:201],SigName = "id")
Sig_mtx = as.matrix(Sig_df)
colnames(Sig_mtx)
#SCC_Bead_TCRVa72_FITC ####
data = read.FCS(paste0(data_dir,"/20250902 XICAI_NK_MulticolorTest_05/SCC_Beads_TCRVa72_FITC Run 1 20250903085648.fcs"))
save_suf = "SCC_Bead_TCRVa72_FITC"
idx_target_fluor = 68
idx_AF_fluor = 4
#RES internal####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
{
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
colnames(data)
#gate clean data for estimation
#gate singlets
data$gate0 = TRUE
data_backup = data
# data = sample_n(data, 20000)
}
gate1<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 FSC-H", feature_col= "488 FSC-A",
parentgate_col= "gate0", newgate_col= "gate1",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate1, df = data)
gate2<-PolygonGating(df=data, x_col= "488 SSC-A", y_col= "488 SSC-H", feature_col= "488 SSC-A",
parentgate_col= "gate1", newgate_col= "gate2",canvas_width=800, canvas_height=400)
data <-GateDecider(gate = gate2, df = data)
gate3<-PolygonGating(df=data, x_col= "488 FSC-A", y_col= "488 SSC-A", feature_col= "488 SSC-A",
parentgate_col= "gate2", newgate_col= "gate3",canvas_width=2000, canvas_height=2000)
data <-GateDecider(gate = gate3, df = data)
{
data = data_backup
data <-GateDecider(gate = gate1, df = data)
data <-GateDecider(gate = gate2, df = data)
data <-GateDecider(gate = gate3, df = data)
data = data[data$gate3,]
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.999)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]
}
data_backup = data
# data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.5999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 10,height = 10)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
View(Sig_mtx)
write.table(Sig_mtx,file = "E:/Sig_mtx.csv",sep = ",")
devtools::document()

x = "Detector",
y = "Signal")
dev.off()
#SCC3_Cell_PECy7_CD4 ####
data = read.FCS(paste0(data_dir,"/Aurora5L/PECy7.fcs"))
save_suf = "SCC3_Cell_PECy7_CD4"
idx_target_fluor = 62
idx_AF_fluor = 1
#RES Aurora5L external####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
{
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
colnames(data)
#gate clean data for estimation
# #gate singlets
# data$gate0 = TRUE
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.99)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]
# data_backup = data
# data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.9999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
# data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
}
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-10, 0, 10), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 15,height = 15)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
df <- data.frame(Detector = factor(rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE]),levels = rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE])),
Signal = as.numeric(Sig_mtx[,c(idx_target_fluor), drop = FALSE]))
ggplot(df, aes(x = Detector, y = Signal, group = 1)) +
geom_line(color = "steelblue", size = 1) +
geom_point(color = "darkred", size = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(title = save_suf,
x = "Detector",
y = "Signal")
dev.off()
#SCC3_Cell_PerCPCy55_CD4 ####
data = read.FCS(paste0(data_dir,"/Aurora5L/PerCPCy55.fcs"))
save_suf = "SCC3_Cell_PerCPCy55_CD4"
idx_target_fluor = 63
idx_AF_fluor = 1
#RES Aurora5L external####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
{
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
colnames(data)
#gate clean data for estimation
# #gate singlets
# data$gate0 = TRUE
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.99)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]
# data_backup = data
# data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.9999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
# data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
}
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-10, 0, 10), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 15,height = 15)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
df <- data.frame(Detector = factor(rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE]),levels = rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE])),
Signal = as.numeric(Sig_mtx[,c(idx_target_fluor), drop = FALSE]))
ggplot(df, aes(x = Detector, y = Signal, group = 1)) +
geom_line(color = "steelblue", size = 1) +
geom_point(color = "darkred", size = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(title = save_suf,
x = "Detector",
y = "Signal")
dev.off()
data = read.FCS(paste0(data_dir,"/Aurora5L/AlexaFluor700.fcs"))
save_suf = "SCC3_Cell_AF_AF"
idx_target_fluor = 1
idx_AF_fluor = 2
#RES Aurora5L external####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
{
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
colnames(data)
#gate clean data for estimation
# #gate singlets
# data$gate0 = TRUE
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.99)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]
# data_backup = data
# data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.9999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
# data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
}
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-10, 0, 10), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 15,height = 15)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
df <- data.frame(Detector = factor(rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE]),levels = rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE])),
Signal = as.numeric(Sig_mtx[,c(idx_target_fluor), drop = FALSE]))
ggplot(df, aes(x = Detector, y = Signal, group = 1)) +
geom_line(color = "steelblue", size = 1) +
geom_point(color = "darkred", size = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(title = save_suf,
x = "Detector",
y = "Signal")
dev.off()
data = read.FCS(paste0(data_dir,"/Aurora5L/AlexaFluor700.fcs"))
save_suf = "SCC3_Cell_AF700_CD4"
idx_target_fluor = 2
idx_AF_fluor = 1
#RES Aurora5L external####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
{
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
colnames(data)
#gate clean data for estimation
# #gate singlets
# data$gate0 = TRUE
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.99)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]
# data_backup = data
# data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.9999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
# data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
}
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-10, 0, 10), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 15,height = 15)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
df <- data.frame(Detector = factor(rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE]),levels = rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE])),
Signal = as.numeric(Sig_mtx[,c(idx_target_fluor), drop = FALSE]))
ggplot(df, aes(x = Detector, y = Signal, group = 1)) +
geom_line(color = "steelblue", size = 1) +
geom_point(color = "darkred", size = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(title = save_suf,
x = "Detector",
y = "Signal")
dev.off()
data = read.FCS(paste0(data_dir,"/Aurora5L/APC.fcs"))
save_suf = "SCC3_Cell_APC_CD4"
idx_target_fluor = 3
idx_AF_fluor = 1
#RES Aurora5L external####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
{
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
colnames(data) = desc
colnames(data)
#gate clean data for estimation
# #gate singlets
# data$gate0 = TRUE
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.99)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]
# data_backup = data
# data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.9999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
# data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
}
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-10, 0, 10), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 15,height = 15)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
df <- data.frame(Detector = factor(rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE]),levels = rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE])),
Signal = as.numeric(Sig_mtx[,c(idx_target_fluor), drop = FALSE]))
ggplot(df, aes(x = Detector, y = Signal, group = 1)) +
geom_line(color = "steelblue", size = 1) +
geom_point(color = "darkred", size = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(title = save_suf,
x = "Detector",
y = "Signal")
dev.off()
#querySig
# library(grid)
Sig_info = querySig()
ResObj = getRes(id = Sig_info$id[130])
#querySig
# library(grid)
Sig_info = querySig()
ResObj = getRes(id = Sig_info$id[130])
View(ResObj)
View(Sig_info)
#check if id is in Sig_list
Sig = Sig_list[[1]]
View(Sig)
names(Sig$Signature)
checkSig_linePlot = function(id){
#check if id is in Sig_list
Sig_list = readRDS(system.file("sig", "Sig_list.rds", package = "USERM"))
if (!(id %in% names(Sig_list))) {
stop(paste0("The input id: ", id, " is not found. Please check with querySig() first."))
}
Sig = Sig_list[[id]]
df <- data.frame(Detector = factor(names(Sig$Signature),levels = names(Sig$Signature)),
Signal = as.numeric(Sig$Signature))
p = ggplot(df, aes(x = Detector, y = Signal, group = 1)) +
geom_line(color = "steelblue", size = 1) +
geom_point(color = "darkred", size = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(title = Sig$id,
x = "Detector",
y = "Signal")
return(p)
}
Sig[["id"]]
devtools::document()
# #read in SCC fcs
library(flowCore)
library(MASS)
library(GateData)
library(ggplot2)
# library(reshape2)
# library(progress)
library(shiny)
# library(DT)
library(dplyr)
# library(rmarkdown)
# library(patchwork)
#
# devtools::install_github("xiangmingcai/USERM")
library(USERM)
library(ComplexHeatmap)
library(circlize)
data_dir = "E:/ResidualModel/RscriptSUPR/data"
report_tmp_dir = "E:/ResidualModel/RscriptSUPR/report_tmp"
tmp_dir = "E:/ResidualModel/RscriptSUPR/tmp"
Sig_list = readRDS(paste0(tmp_dir,"/Sig_list.rds"))
# Sig_list$SCC2_Cell_BV421_CD4$Signature = Sig_list$SCC2_Cell_BV421_CD4$Signature[names(Sig_list$SCC_Bead_CD4_NFR700$Signature)]
# Sig_df = SigList2df(SigList= Sig_list[1:63],SigName = "id")
# Sig_df = SigList2df(SigList= Sig_list[1:137],SigName = "id")
Sig_df = SigList2df(SigList= Sig_list[138:201],SigName = "id")
Sig_mtx = as.matrix(Sig_df)
colnames(Sig_mtx)
#SCC3_Cell_LDBlue_LD ####
data = read.FCS(paste0(data_dir,"/Aurora5L/Titrations_Titration 1_250_2025_02_25_13_07_04.fcs"))
save_suf = "SCC3_Cell_LDBlue_LD"
idx_target_fluor = 64
idx_AF_fluor = 1
#RES Aurora5L external####
colnames(Sig_mtx)[idx_target_fluor]
colnames(Sig_mtx)[idx_AF_fluor]
#the following code applies for all SCCs
desc = data@parameters@data$desc
data = exprs(data)
data = as.data.frame(data)
#unmix with target_fluor and AF
data = data[,rownames(Sig_df)]
R = t(as.matrix(data))
A = Sig_mtx[,c(idx_target_fluor,idx_AF_fluor), drop = FALSE]
A_pinv = ginv(A)
B =  A_pinv %*% R
t_B = t(B)
colnames(t_B) = c(colnames(Sig_mtx)[idx_target_fluor],colnames(Sig_mtx)[idx_AF_fluor])
data = cbind(data,t_B)
data$gate0 = TRUE
#gate normal samples
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] <
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.99)),]
data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] >
quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.61)),]
data_backup = data
data = sample_n(data, 30000)
# data = data[(data[,colnames(Sig_mtx)[idx_AF_fluor]] < quantile(data[,colnames(Sig_mtx)[idx_AF_fluor]],0.9999)),]
gate_normal<-PolygonGating(df=data, x_col= colnames(Sig_mtx)[idx_target_fluor],
y_col= colnames(Sig_mtx)[idx_AF_fluor],
feature_col= colnames(Sig_mtx)[idx_target_fluor],
parentgate_col= "gate0", newgate_col= "gate_normal",canvas_width=800, canvas_height=400)
# data = data_backup
data = GateDecider(gate = gate_normal, df = data)
data = data[data$gate_normal,rownames(Sig_df)]
#calculate residuals
R = as.matrix(data)
A = Sig_mtx[,c(idx_target_fluor), drop = FALSE]
ResObj = CreateRes(id = colnames(Sig_mtx)[idx_target_fluor], R = R, A = A)
ResObj = SlopEstimation(Res = ResObj, bin_num = 30)
col_fun = colorRamp2(c(-10, 0, 10), c("blue", "white", "red"))
pdf(file = paste0(tmp_dir,"/",save_suf,"_slopmtx.pdf"),width = 15,height = 15)
Heatmap(ResObj$slopMtx,col = col_fun, cluster_rows = FALSE,cluster_columns = FALSE,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%.1f", ResObj$slopMtx[i, j]), x, y, gp = gpar(fontsize = 6))
},column_title = colnames(Sig_mtx)[idx_target_fluor],name = "beta")
dev.off()
saveRDS(ResObj, file = paste0(tmp_dir,"/ResObj_",save_suf,".rds"))
saveRDS(list(gate_normal), file = paste0(tmp_dir,"/",save_suf,"_gatelist.rds"))
saveRDS(c("gate_normal"), file = paste0(tmp_dir,"/",save_suf,"_gatenames.rds"))
df <- data.frame(Detector = factor(rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE]),levels = rownames(Sig_mtx[,c(idx_target_fluor), drop = FALSE])),
Signal = as.numeric(Sig_mtx[,c(idx_target_fluor), drop = FALSE]))
ggplot(df, aes(x = Detector, y = Signal, group = 1)) +
geom_line(color = "steelblue", size = 1) +
geom_point(color = "darkred", size = 2) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(title = save_suf,
x = "Detector",
y = "Signal")
dev.off()
devtools::document()
devtools::document()
# library(rmarkdown)
# library(patchwork)
#
devtools::install_github("xiangmingcai/USERM")
# library(rmarkdown)
# library(patchwork)
#
# devtools::install_github("xiangmingcai/USERM")
library(USERM)
#querySig
# library(grid)
Sig_info = querySig()
Sig_mtx  = getSigMtx(ids = c(Sig_info$id[c(66,69,71)]))
SuprObj = CreateUserm(A = Sig_mtx)
#add ResObj into SuprObj
for (save_suf in colnames(Sig_mtx)) {
ResObj = getRes(id = save_suf)
SuprObj = AddRes2Userm(Res = ResObj, Userm = SuprObj)
}
SuprObj[["Scale_df"]][["min"]] = -100
SuprObj[["Scale_df"]][["max"]] = 1000
SuprObj[["Scale_df"]][["scale"]] = "Linear"
SuprObj[["Scale_df"]][["cofactor"]] = 10
#
#
# SuprObj = AddScale(Userm = SuprObj,fluor = colnames(Sig_mtx)[1],min = -100, max = 1000, scale = "Linear", cofactor = 10)# c("Linear","Log10","Arcsinh")
# SuprObj = AddScale(Userm = SuprObj,fluor = colnames(Sig_mtx)[2],min = -100, max = 1000, scale = "Log10", cofactor = 10)# c("Linear","Log10","Arcsinh")
# SuprObj = AddScale(Userm = SuprObj,fluor = colnames(Sig_mtx)[3],min = -100, max = 1000, scale = "Arcsinh", cofactor = 10)# c("Linear","Log10","Arcsinh")
# SuprObj = AddScale(Userm = SuprObj,fluor = colnames(Sig_mtx)[4],min = -100, max = 1000, scale = "Arcsinh", cofactor = 10)# c("Linear","Log10","Arcsinh")
SuprObj$Intensity_mtx[,1] = 100*c(1:length(SuprObj$fluors))
PredOneSpread(Userm = SuprObj,population_id = c("V1"))
SuprObj$Intensity_mtx[,2] = 100*c(1:length(SuprObj$fluors))
SuprObj$Intensity_mtx[,3] = 200*c(1:length(SuprObj$fluors))
PredMultipleSpread(Userm = SuprObj,population_ids = c("V1","V2","V3"))
devtools::document()

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Use Custom SCC ‚Ä¢ USERM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Use Custom SCC">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">USERM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/instruction_basic.html">Basic Instruction</a></li>
    <li><a class="dropdown-item" href="../articles/instruction_customFCS.html">Use Custom SCC</a></li>
    <li><a class="dropdown-item" href="../articles/instruction_interprateHighCoef.html">Interprate Spread</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/xiangmingcai/USERM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Use Custom SCC</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/xiangmingcai/USERM/blob/HEAD/vignettes/instruction_customFCS.Rmd" class="external-link"><code>vignettes/instruction_customFCS.Rmd</code></a></small>
      <div class="d-none name"><code>instruction_customFCS.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="instruction-for-userm-use-with-custom-sccs">instruction for USERM use with Custom SCCs<a class="anchor" aria-label="anchor" href="#instruction-for-userm-use-with-custom-sccs"></a>
</h2>
<p>Xiangming Cai</p>
<p>2025-11-22</p>
<div class="section level3">
<h3 id="introduction">üîç Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>The USERM supports predicting spread for unmixed spectral flow
cytometry data, which helps for panel design and interpratation of
unmixed results. There are over 200 built-in Single-color controls
(SCCs) provided by the USERM. However, users can also apply USERM on
their own SCCs. This helps when users need specific fluorescence not
provided by USERM, or when they are using instruments not included in
the USERM.</p>
<p>In this instruction, we will show how to apply USERM on custom SCCs.
We need to first extract signatures from SCCs and prepare res objects
for each SCC. Then, we can easily predict with these custom SCCs (or
together with built-in SCCs).</p>
</div>
<div class="section level3">
<h3 id="step-0-load-packages-and-set-custom_dir">Step 0 üìà load packages and set custom_dir<a class="anchor" aria-label="anchor" href="#step-0-load-packages-and-set-custom_dir"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("xiangmingcai/USERM")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://xiangmingcai.github.io/USERM">USERM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">flowCore</span><span class="op">)</span></span>
<span><span class="co"># devtools::install_github("xiangmingcai/GateData")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">GateData</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/circlize" class="external-link">circlize</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/ComplexHeatmap" class="external-link">ComplexHeatmap</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">custom_dir</span> <span class="op">=</span> <span class="st">"E:/MyFolder"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">custom_dir</span>,<span class="st">"/sig"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">custom_dir</span>,<span class="st">"/res"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The custom_dir will store generated files, which is required for
prediction.</p>
</div>
<div class="section level3">
<h3 id="step-1-prepare-signature">Step 1 üìà Prepare signature<a class="anchor" aria-label="anchor" href="#step-1-prepare-signature"></a>
</h3>
<p>We need to prepare signatures for each SCC seperately. The steps for
extracting Autofluroescence (AF) are almost the same, unless
specified.</p>
<p>Normally, unstained sample is needed for AF extraction. However, you
can extract AF from negative population in SCC if you do not have
unstained sample.</p>
<div class="section level4">
<h4 id="step-1-1-read-in-scc-fcs">step 1.1 read in scc fcs<a class="anchor" aria-label="anchor" href="#step-1-1-read-in-scc-fcs"></a>
</h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/read.FCS.html" class="external-link">read.FCS</a></span><span class="op">(</span><span class="st">"E:/Data/SCC_Cell_CD2_SB780 Run 1 20251024102726.fcs"</span><span class="op">)</span> <span class="co">#set the path to your SCC .fcs file</span></span>
<span><span class="co"># data = read.FCS("E:/Data/unstained_1 Run 1 20251024100712.fcs") #this is for AF</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">@</span><span class="va">parameters</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">desc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">@</span><span class="va">parameters</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">desc</span> <span class="op">=</span> <span class="va">data</span><span class="op">@</span><span class="va">parameters</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">desc</span> <span class="co"># "desc" or "name" are used for different insruments. Ues the one with correct detector names.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/exprs.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">=</span> <span class="va">desc</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(<span class="fu">head</span>(data<span class="sc">@</span>parameters<span class="sc">@</span>data<span class="sc">$</span>desc))</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>       <span class="sc">$</span>P1S        <span class="sc">$</span>P2S        <span class="sc">$</span>P3S        <span class="sc">$</span>P4S        <span class="sc">$</span>P5S        <span class="sc">$</span>P6S </span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>     <span class="st">"Time"</span>  <span class="st">"Run Time"</span>  <span class="st">"Event ID"</span> <span class="st">"488 FSC-H"</span> <span class="st">"488 FSC-A"</span> <span class="st">"488 FSC-W"</span> </span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(<span class="fu">head</span>(data<span class="sc">@</span>parameters<span class="sc">@</span>data<span class="sc">$</span>name))</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>      <span class="sc">$</span>P1N       <span class="sc">$</span>P2N       <span class="sc">$</span>P3N       <span class="sc">$</span>P4N       <span class="sc">$</span>P5N       <span class="sc">$</span>P6N </span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>    <span class="st">"Time"</span> <span class="st">"Run Time"</span> <span class="st">"Event ID"</span>  <span class="st">"FSC51-H"</span>  <span class="st">"FSC51-A"</span>  <span class="st">"FSC51-W"</span> </span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">head</span>(data)</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  Time Run Time Event ID <span class="dv">488</span> FSC<span class="sc">-</span>H <span class="dv">488</span> FSC<span class="sc">-</span>A <span class="dv">488</span> FSC<span class="sc">-</span>W  <span class="dv">488</span> FSC <span class="dv">488</span> SSC<span class="sc">-</span>H <span class="dv">488</span> SSC<span class="sc">-</span>A <span class="dv">488</span> SSC<span class="sc">-</span>W  <span class="dv">488</span> SSC <span class="dv">488</span> FSC Polar<span class="sc">-</span>H</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="dv">1</span>  <span class="dv">966</span>      <span class="dv">966</span>        <span class="dv">1</span>  <span class="fl">11053.84</span>  <span class="fl">11367.57</span>  <span class="fl">13671.88</span> <span class="fl">11367.57</span>  <span class="fl">26975.94</span>  <span class="fl">27930.18</span>  <span class="fl">13671.88</span> <span class="fl">27930.18</span>        <span class="fl">12814.00</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="dv">2</span>  <span class="dv">991</span>      <span class="dv">991</span>        <span class="dv">2</span>  <span class="fl">46370.00</span>  <span class="fl">53884.65</span>  <span class="fl">15234.38</span> <span class="fl">53884.65</span>  <span class="fl">92353.13</span>  <span class="fl">99999.98</span>  <span class="fl">16210.94</span> <span class="fl">99999.98</span>        <span class="fl">54518.63</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="dv">3</span> <span class="dv">1066</span>     <span class="dv">1066</span>        <span class="dv">3</span>  <span class="fl">53632.18</span>  <span class="fl">60693.39</span>  <span class="fl">15039.06</span> <span class="fl">60693.39</span>  <span class="fl">38315.37</span>  <span class="fl">43835.29</span>  <span class="fl">15039.06</span> <span class="fl">43835.29</span>        <span class="fl">62066.83</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="dv">4</span> <span class="dv">1135</span>     <span class="dv">1135</span>        <span class="dv">4</span>  <span class="fl">56737.39</span>  <span class="fl">64002.36</span>  <span class="fl">15039.06</span> <span class="fl">64002.36</span>  <span class="fl">37044.19</span>  <span class="fl">43117.40</span>  <span class="fl">15429.69</span> <span class="fl">43117.40</span>        <span class="fl">66313.27</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="dv">5</span> <span class="dv">1233</span>     <span class="dv">1233</span>        <span class="dv">5</span>  <span class="fl">31609.00</span>  <span class="fl">36513.11</span>  <span class="fl">15429.69</span> <span class="fl">36513.11</span>  <span class="fl">40273.66</span>  <span class="fl">46527.43</span>  <span class="fl">15039.06</span> <span class="fl">46527.43</span>        <span class="fl">37028.07</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="dv">6</span> <span class="dv">1274</span>     <span class="dv">1274</span>        <span class="dv">6</span>  <span class="fl">21817.04</span>  <span class="fl">26400.30</span>  <span class="fl">16015.62</span> <span class="fl">26400.30</span>  <span class="fl">55891.99</span>  <span class="fl">66402.58</span>  <span class="fl">15625.00</span> <span class="fl">66402.58</span>        <span class="fl">24883.68</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>...</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>  <span class="dv">405</span> FSC<span class="sc">-</span>A <span class="dv">405</span> FSC<span class="sc">-</span>W  <span class="dv">405</span> FSC <span class="dv">405</span> SSC<span class="sc">-</span>H <span class="dv">405</span> SSC<span class="sc">-</span>A <span class="dv">405</span> SSC<span class="sc">-</span>W   <span class="dv">405</span> SSC 349nm <span class="sc">-</span> <span class="dv">387</span><span class="sc">/</span><span class="dv">11</span><span class="sc">-</span>A 349nm <span class="sc">-</span> <span class="dv">387</span><span class="sc">/</span><span class="dv">11</span> 349nm <span class="sc">-</span> <span class="dv">420</span><span class="sc">/</span><span class="dv">10</span><span class="sc">-</span>A</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="dv">1</span>  <span class="fl">17551.05</span>  <span class="fl">13085.94</span> <span class="fl">17551.05</span>  <span class="fl">9475.255</span>  <span class="fl">9475.971</span>  <span class="fl">13476.56</span>  <span class="fl">9475.971</span>         <span class="fl">2.872925</span>       <span class="fl">2.872925</span>        <span class="fl">6.1988525</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="dv">2</span>  <span class="fl">57257.59</span>  <span class="fl">13671.88</span> <span class="fl">57257.59</span> <span class="fl">45441.043</span> <span class="fl">53445.719</span>  <span class="fl">15234.38</span> <span class="fl">53445.719</span>         <span class="fl">4.613342</span>       <span class="fl">4.613342</span>        <span class="fl">2.5987549</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="dv">3</span>  <span class="fl">37115.38</span>  <span class="fl">13085.94</span> <span class="fl">37115.38</span> <span class="fl">14217.615</span> <span class="fl">15710.759</span>  <span class="fl">14648.44</span> <span class="fl">15710.759</span>         <span class="fl">2.360291</span>       <span class="fl">2.360291</span>        <span class="fl">8.5353394</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="dv">4</span>  <span class="fl">46662.83</span>  <span class="fl">12500.00</span> <span class="fl">46662.83</span> <span class="fl">16527.271</span> <span class="fl">18565.000</span>  <span class="fl">14843.75</span> <span class="fl">18565.000</span>         <span class="fl">6.043884</span>       <span class="fl">6.043884</span>        <span class="fl">0.7271729</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="dv">5</span>  <span class="fl">47614.96</span>  <span class="fl">11914.06</span> <span class="fl">47614.96</span> <span class="fl">15896.583</span> <span class="fl">17418.504</span>  <span class="fl">14257.81</span> <span class="fl">17418.504</span>         <span class="fl">1.561584</span>       <span class="fl">1.561584</span>        <span class="fl">1.0132446</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="dv">6</span>  <span class="fl">46072.35</span>  <span class="fl">13476.56</span> <span class="fl">46072.35</span> <span class="fl">22898.090</span> <span class="fl">27236.199</span>  <span class="fl">15625.00</span> <span class="fl">27236.199</span>         <span class="fl">2.038452</span>       <span class="fl">2.038452</span>        <span class="fl">0.8344116</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>...</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="step-1-2-set-scc-fcs-info">step 1.2 set scc fcs info<a class="anchor" aria-label="anchor" href="#step-1-2-set-scc-fcs-info"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">peak_channel</span> <span class="op">=</span> <span class="st">'405nm - 770/LP-A'</span> <span class="co">#</span></span>
<span><span class="va">save_suf</span> <span class="op">=</span> <span class="st">"SCCcustom_Cell_CD2_SB780"</span></span>
<span><span class="va">PrimaryName</span> <span class="op">=</span> <span class="st">"CD2"</span></span>
<span><span class="va">SecondaryName</span> <span class="op">=</span> <span class="st">"SB780"</span></span>
<span></span>
<span><span class="co"># save_suf = "SCCcustom_Cell_AF_AF" #For AF.</span></span>
<span><span class="co"># PrimaryName = "AF" #For AF.</span></span>
<span><span class="co"># SecondaryName = "AF" #For AF.</span></span></code></pre></div>
<p>You may use public resource (e.g.¬†fluorofinder) to find the peak
channel of your SCC.</p>
<p>The save_suf is important name of the SCC, which should be unique. it
is recommended to follow the naming pattern shown here. There are 4
elements in the name, which are separated by underscore.</p>
<p><strong>The first element is ‚Äúbatch‚Äù element.</strong> The built-in
SCCs use ‚ÄúSCC1‚Äù, ‚ÄúSCC2‚Äù, and so on to annotate SCC files acquired in
distinct batches.You can use ‚ÄúSCCcustom‚Äù to distinguish custom SCCs and
built-in SCCs. You can also use others that makes sense to you.</p>
<p><strong>The second element is ‚Äútype‚Äù element.</strong> Now We only
have ‚ÄúCell‚Äù and ‚ÄúBead‚Äù.</p>
<p><strong>The third element is ‚ÄúPrimaryName‚Äù.</strong> Normally we put
target of the antibody hereÔºåe.g.¬†CD2.</p>
<p><strong>The last element is ‚ÄúSecondaryName‚Äù,</strong> Normally we put
fluroescence of the antibody here, e.g.¬†SB780.</p>
<p>Please avoid using space or underscore in these elements.</p>
</div>
<div class="section level4">
<h4 id="step-1-3-gate-positive-popualtion-and-negative-population">step 1.3 gate positive popualtion and negative population<a class="anchor" aria-label="anchor" href="#step-1-3-gate-positive-popualtion-and-negative-population"></a>
</h4>
<p>In this step, we need to find positive and negative populations. You
can use the GateData R package or other packages that works for you.
Here we show how to gate a subset population with the GateData</p>
<p>For detailed instruction of GateData, please refer to <a href="https://github.com/xiangmingcai/GateData" class="external-link">GateData</a></p>
<p>Brief instruction: draw a gate, and click 3 buttons in order.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. sample cells.</span></span>
<span><span class="co">#You may modify code here to sample specific set for rare markers.</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">gate0</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">20000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. gate singlets if need</span></span>
<span><span class="co"># You can change the FSC and SSC names for specific instrument.</span></span>
<span><span class="co"># use colnames(data) to find available paramters</span></span>
<span><span class="co"># colnames(data)</span></span>
<span><span class="va">gate1</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/PolygonGating.html" class="external-link">PolygonGating</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">data</span>, x_col<span class="op">=</span> <span class="st">"488 FSC-A"</span>, y_col<span class="op">=</span> <span class="st">"488 FSC-H"</span>, feature_col<span class="op">=</span> <span class="st">"488 FSC-A"</span>,</span>
<span>                     parentgate_col<span class="op">=</span> <span class="st">"gate0"</span>, newgate_col<span class="op">=</span> <span class="st">"gate1"</span>,canvas_width<span class="op">=</span><span class="fl">800</span>, canvas_height<span class="op">=</span><span class="fl">400</span>,</span>
<span>                     title_text <span class="op">=</span> <span class="st">"Gate singlets"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate1</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">gate2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/PolygonGating.html" class="external-link">PolygonGating</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">data</span>, x_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>, y_col<span class="op">=</span> <span class="st">"488 SSC-H"</span>, feature_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>,</span>
<span>                     parentgate_col<span class="op">=</span> <span class="st">"gate1"</span>, newgate_col<span class="op">=</span> <span class="st">"gate2"</span>,canvas_width<span class="op">=</span><span class="fl">800</span>, canvas_height<span class="op">=</span><span class="fl">400</span>,</span>
<span>                     title_text <span class="op">=</span> <span class="st">"Gate singlets"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate2</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_sig_gatesiglets_1.jpg" width="500/"></p>

<p align="center">
</p>
<p><img src="../reference/figures/custom_sig_gatesiglets_2.jpg" width="500/"></p>

<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 3. gate target population (e.g. lymphocytes)</span></span>
<span><span class="va">gate3</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/PolygonGating.html" class="external-link">PolygonGating</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">data</span>, x_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>, y_col<span class="op">=</span> <span class="st">"488 FSC-A"</span>, feature_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>,</span>
<span>                     parentgate_col<span class="op">=</span> <span class="st">"gate2"</span>, newgate_col<span class="op">=</span> <span class="st">"gate3"</span>,canvas_width<span class="op">=</span><span class="fl">800</span>, canvas_height<span class="op">=</span><span class="fl">500</span>,</span>
<span>                     title_text <span class="op">=</span> <span class="st">"Gate target population"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate3</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_sig_gatesiglets_3.jpg" width="500/"></p>

<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 4. gate positive and negative populations.</span></span>
<span><span class="co">#For autofluorescence, randomly gate a negative populaiton and assign zero to it.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">gate3</span>,<span class="op">]</span></span>
<span><span class="va">gate_pos</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/PolygonGating.html" class="external-link">PolygonGating</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">data</span>, x_col<span class="op">=</span> <span class="va">peak_channel</span>, y_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>, feature_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>,</span>
<span>                        parentgate_col<span class="op">=</span> <span class="st">"gate3"</span>, newgate_col<span class="op">=</span> <span class="st">"gate_pos"</span>,canvas_width<span class="op">=</span><span class="fl">800</span>, canvas_height<span class="op">=</span><span class="fl">400</span>,</span>
<span>                        title_text <span class="op">=</span> <span class="st">"Gate positive population"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate_pos</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">gate_neg</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/PolygonGating.html" class="external-link">PolygonGating</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">data</span>, x_col<span class="op">=</span> <span class="va">peak_channel</span>, y_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>, feature_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>,</span>
<span>                        parentgate_col<span class="op">=</span> <span class="st">"gate3"</span>, newgate_col<span class="op">=</span> <span class="st">"gate_neg"</span>,canvas_width<span class="op">=</span><span class="fl">800</span>, canvas_height<span class="op">=</span><span class="fl">400</span>,</span>
<span>                        title_text <span class="op">=</span> <span class="st">"Gate negative population"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate_neg</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">gate_pos</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">gate_neg</span><span class="op">)</span></span>
<span><span class="va">data_pos</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">gate_pos</span>,<span class="op">]</span></span>
<span><span class="va">data_neg</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">gate_neg</span>,<span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="co"># data_neg[,] &lt;- 0 # For autofluorescence, assign zero to data_neg</span></span>
<span></span>
<span><span class="co"># #you may save the gates if needed.</span></span>
<span><span class="co"># saveRDS(list(gate1,gate2,gate3,gate_pos,gate_neg), file = paste0(custom_dir,"/",save_suf,"_gatelist.rds"))</span></span>
<span><span class="co"># saveRDS(c("gate1","gate2","gate3","gate_pos","gate_neg"), file = paste0(custom_dir,"/",save_suf,"_gatenames.rds"))</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">table</span>(data<span class="sc">$</span>gate_pos)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="cn">FALSE</span>  <span class="cn">TRUE</span> </span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="dv">11669</span>   <span class="dv">361</span> </span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">table</span>(data<span class="sc">$</span>gate_neg)</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="cn">FALSE</span>  <span class="cn">TRUE</span> </span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a> <span class="dv">6202</span>  <span class="dv">5828</span> </span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_sig_gatesiglets_4.jpg" width="500/"></p>

<p align="center">
</p>
<p><img src="../reference/figures/custom_sig_gatesiglets_5.jpg" width="500/"></p>

</div>
<div class="section level4">
<h4 id="step-1-4-extract-signatures">step 1.4 extract signatures<a class="anchor" aria-label="anchor" href="#step-1-4-extract-signatures"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Select detectors. Please select only the detectors for unmixing</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="va">cols</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fl">28</span>, to<span class="op">=</span><span class="fl">128</span>, by<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Sig</span> <span class="op">=</span> <span class="fu"><a href="../reference/ExtractSig.html">ExtractSig</a></span><span class="op">(</span>df_pos <span class="op">=</span> <span class="va">data_pos</span>,df_neg <span class="op">=</span> <span class="va">data_neg</span>,</span>
<span>                 cols <span class="op">=</span> <span class="va">cols</span>, method <span class="op">=</span> <span class="st">"median"</span>,</span>
<span>                 PrimaryName <span class="op">=</span> <span class="va">PrimaryName</span>,</span>
<span>                 SecondaryName <span class="op">=</span> <span class="va">SecondaryName</span>,</span>
<span>                 id <span class="op">=</span> <span class="va">save_suf</span>,</span>
<span>                 instrument <span class="op">=</span> <span class="st">"Xenith"</span>,</span>
<span>                 Source <span class="op">=</span> <span class="st">"YourName"</span>,</span>
<span>                 Note <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#you may briefly check the signature</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Detector <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Sig</span><span class="op">$</span><span class="va">Signature</span><span class="op">)</span>,Signal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Sig</span><span class="op">$</span><span class="va">Signature</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Detector</span>, y <span class="op">=</span> <span class="va">Signal</span>, group <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"steelblue"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"darkred"</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="va">save_suf</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Detector"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Signal"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">colnames</span>(data)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  [<span class="dv">1</span>] <span class="st">"Time"</span>             <span class="st">"Run Time"</span>         <span class="st">"Event ID"</span>         <span class="st">"488 FSC-H"</span>        <span class="st">"488 FSC-A"</span>        <span class="st">"488 FSC-W"</span>       </span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  [<span class="dv">7</span>] <span class="st">"488 FSC"</span>          <span class="st">"488 SSC-H"</span>        <span class="st">"488 SSC-A"</span>        <span class="st">"488 SSC-W"</span>        <span class="st">"488 SSC"</span>          <span class="st">"488 FSC Polar-H"</span> </span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a> [<span class="dv">13</span>] <span class="st">"488 FSC Polar-A"</span>  <span class="st">"488 FSC Polar-W"</span>  <span class="st">"488 FSC Polar"</span>    <span class="st">"488 SSC Polar-H"</span>  <span class="st">"488 SSC Polar-A"</span>  <span class="st">"488 SSC Polar-W"</span> </span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a> [<span class="dv">19</span>] <span class="st">"488 SSC Polar"</span>    <span class="st">"405 FSC-H"</span>        <span class="st">"405 FSC-A"</span>        <span class="st">"405 FSC-W"</span>        <span class="st">"405 FSC"</span>          <span class="st">"405 SSC-H"</span>       </span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a> [<span class="dv">25</span>] <span class="st">"405 SSC-A"</span>        <span class="st">"405 SSC-W"</span>        <span class="st">"405 SSC"</span>          <span class="st">"349nm - 387/11-A"</span> <span class="st">"349nm - 387/11"</span>   <span class="st">"349nm - 420/10-A"</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a> [<span class="dv">31</span>] <span class="st">"349nm - 420/10"</span>   <span class="st">"349nm - 434/17-A"</span> <span class="st">"349nm - 434/17"</span>   <span class="st">"349nm - 455/14-A"</span> <span class="st">"349nm - 455/14"</span>   <span class="st">"349nm - 473/15-A"</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a> [<span class="dv">37</span>] <span class="st">"349nm - 473/15"</span>   <span class="st">"349nm - 507/19-A"</span> <span class="st">"349nm - 507/19"</span>   <span class="st">"349nm - 549/15-A"</span> <span class="st">"349nm - 549/15"</span>   <span class="st">"349nm - 575/15-A"</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a> [<span class="dv">43</span>] <span class="st">"349nm - 575/15"</span>   <span class="st">"349nm - 615/24-A"</span> <span class="st">"349nm - 615/24"</span>   <span class="st">"349nm - 670/30-A"</span> <span class="st">"349nm - 670/30"</span>   <span class="st">"349nm - 728/40-A"</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a> [<span class="dv">49</span>] <span class="st">"349nm - 728/40"</span>   <span class="st">"349nm - 810/25-A"</span> <span class="st">"349nm - 810/25"</span>   <span class="st">"405nm - 420/10-A"</span> <span class="st">"405nm - 420/10"</span>   <span class="st">"405nm - 434/17-A"</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a> [<span class="dv">55</span>] <span class="st">"405nm - 434/17"</span>   <span class="st">"405nm - 455/14-A"</span> <span class="st">"405nm - 455/14"</span>   <span class="st">"405nm - 473/15-A"</span> <span class="st">"405nm - 473/15"</span>   <span class="st">"405nm - 507/19-A"</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a> [<span class="dv">61</span>] <span class="st">"405nm - 507/19"</span>   <span class="st">"405nm - 549/15-A"</span> <span class="st">"405nm - 549/15"</span>   <span class="st">"405nm - 575/15-A"</span> <span class="st">"405nm - 575/15"</span>   <span class="st">"405nm - 615/24-A"</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a> [<span class="dv">67</span>] <span class="st">"405nm - 615/24"</span>   <span class="st">"405nm - 661/20-A"</span> <span class="st">"405nm - 661/20"</span>   <span class="st">"405nm - 710/20-A"</span> <span class="st">"405nm - 710/20"</span>   <span class="st">"405nm - 747/33-A"</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a> [<span class="dv">73</span>] <span class="st">"405nm - 747/33"</span>   <span class="st">"405nm - 770/LP-A"</span> <span class="st">"405nm - 770/LP"</span>   <span class="st">"488nm - 520/40-A"</span> <span class="st">"488nm - 520/40"</span>   <span class="st">"488nm - 549/15-A"</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a> [<span class="dv">79</span>] <span class="st">"488nm - 549/15"</span>   <span class="st">"488nm - 583/30-A"</span> <span class="st">"488nm - 583/30"</span>   <span class="st">"488nm - 615/24-A"</span> <span class="st">"488nm - 615/24"</span>   <span class="st">"488nm - 670/30-A"</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a> [<span class="dv">85</span>] <span class="st">"488nm - 670/30"</span>   <span class="st">"488nm - 720/24-A"</span> <span class="st">"488nm - 720/24"</span>   <span class="st">"488nm - 750/LP-A"</span> <span class="st">"488nm - 750/LP"</span>   <span class="st">"561nm - 575/15-A"</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a> [<span class="dv">91</span>] <span class="st">"561nm - 575/15"</span>   <span class="st">"561nm - 589/15-A"</span> <span class="st">"561nm - 589/15"</span>   <span class="st">"561nm - 605/15-A"</span> <span class="st">"561nm - 605/15"</span>   <span class="st">"561nm - 622/15-A"</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a> [<span class="dv">97</span>] <span class="st">"561nm - 622/15"</span>   <span class="st">"561nm - 661/20-A"</span> <span class="st">"561nm - 661/20"</span>   <span class="st">"561nm - 685/15-A"</span> <span class="st">"561nm - 685/15"</span>   <span class="st">"561nm - 700/13-A"</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>[<span class="dv">103</span>] <span class="st">"561nm - 700/13"</span>   <span class="st">"561nm - 720/24-A"</span> <span class="st">"561nm - 720/24"</span>   <span class="st">"561nm - 760/50-A"</span> <span class="st">"561nm - 760/50"</span>   <span class="st">"561nm - 810/25-A"</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>[<span class="dv">109</span>] <span class="st">"561nm - 810/25"</span>   <span class="st">"561nm - 844/25-A"</span> <span class="st">"561nm - 844/25"</span>   <span class="st">"561nm - 860/LP-A"</span> <span class="st">"561nm - 860/LP"</span>   <span class="st">"637nm - 661/20-A"</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>[<span class="dv">115</span>] <span class="st">"637nm - 661/20"</span>   <span class="st">"637nm - 700/13-A"</span> <span class="st">"637nm - 700/13"</span>   <span class="st">"637nm - 720/24-A"</span> <span class="st">"637nm - 720/24"</span>   <span class="st">"637nm - 760/50-A"</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>[<span class="dv">121</span>] <span class="st">"637nm - 760/50"</span>   <span class="st">"637nm - 785/LP-A"</span> <span class="st">"637nm - 785/LP"</span>   <span class="st">"781nm - 810/25-A"</span> <span class="st">"781nm - 810/25"</span>   <span class="st">"781nm - 844/25-A"</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>[<span class="dv">127</span>] <span class="st">"781nm - 844/25"</span>   <span class="st">"781nm - 860/LP-A"</span> <span class="st">"781nm - 860/LP"</span>   <span class="st">"GateMatch"</span>        <span class="st">"SortIndex"</span>        <span class="st">"DropsSorted"</span>     </span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>[<span class="dv">133</span>] <span class="st">"SortDestination"</span>  <span class="st">"gate0"</span>            <span class="st">"gate1"</span>            <span class="st">"gate2"</span>            <span class="st">"gate3"</span>            <span class="st">"gate_pos"</span>        </span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>[<span class="dv">139</span>] <span class="st">"gate_neg"</span>        </span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(cols)</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a> [<span class="dv">1</span>] <span class="st">"349nm - 387/11-A"</span> <span class="st">"349nm - 420/10-A"</span> <span class="st">"349nm - 434/17-A"</span> <span class="st">"349nm - 455/14-A"</span> <span class="st">"349nm - 473/15-A"</span> <span class="st">"349nm - 507/19-A"</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a> [<span class="dv">7</span>] <span class="st">"349nm - 549/15-A"</span> <span class="st">"349nm - 575/15-A"</span> <span class="st">"349nm - 615/24-A"</span> <span class="st">"349nm - 670/30-A"</span> <span class="st">"349nm - 728/40-A"</span> <span class="st">"349nm - 810/25-A"</span></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>[<span class="dv">13</span>] <span class="st">"405nm - 420/10-A"</span> <span class="st">"405nm - 434/17-A"</span> <span class="st">"405nm - 455/14-A"</span> <span class="st">"405nm - 473/15-A"</span> <span class="st">"405nm - 507/19-A"</span> <span class="st">"405nm - 549/15-A"</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>[<span class="dv">19</span>] <span class="st">"405nm - 575/15-A"</span> <span class="st">"405nm - 615/24-A"</span> <span class="st">"405nm - 661/20-A"</span> <span class="st">"405nm - 710/20-A"</span> <span class="st">"405nm - 747/33-A"</span> <span class="st">"405nm - 770/LP-A"</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>[<span class="dv">25</span>] <span class="st">"488nm - 520/40-A"</span> <span class="st">"488nm - 549/15-A"</span> <span class="st">"488nm - 583/30-A"</span> <span class="st">"488nm - 615/24-A"</span> <span class="st">"488nm - 670/30-A"</span> <span class="st">"488nm - 720/24-A"</span></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a>[<span class="dv">31</span>] <span class="st">"488nm - 750/LP-A"</span> <span class="st">"561nm - 575/15-A"</span> <span class="st">"561nm - 589/15-A"</span> <span class="st">"561nm - 605/15-A"</span> <span class="st">"561nm - 622/15-A"</span> <span class="st">"561nm - 661/20-A"</span></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>[<span class="dv">37</span>] <span class="st">"561nm - 685/15-A"</span> <span class="st">"561nm - 700/13-A"</span> <span class="st">"561nm - 720/24-A"</span> <span class="st">"561nm - 760/50-A"</span> <span class="st">"561nm - 810/25-A"</span> <span class="st">"561nm - 844/25-A"</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>[<span class="dv">43</span>] <span class="st">"561nm - 860/LP-A"</span> <span class="st">"637nm - 661/20-A"</span> <span class="st">"637nm - 700/13-A"</span> <span class="st">"637nm - 720/24-A"</span> <span class="st">"637nm - 760/50-A"</span> <span class="st">"637nm - 785/LP-A"</span></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>[<span class="dv">49</span>] <span class="st">"781nm - 810/25-A"</span> <span class="st">"781nm - 844/25-A"</span> <span class="st">"781nm - 860/LP-A"</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_sig_CD2.jpg" width="500/"></p>

For AF:
<p align="center">
</p>
<p><img src="../reference/figures/custom_sig_AF.jpg" width="500/"></p>

</div>
<div class="section level4">
<h4 id="step-1-5-add-signatures-to-custom_sig_list">step 1.5 add signatures to Custom_Sig_list<a class="anchor" aria-label="anchor" href="#step-1-5-add-signatures-to-custom_sig_list"></a>
</h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Read in Custom_Sig_list</span></span>
<span><span class="co">#For first SCC (that means you do not have a Custom_Sig_list yet)</span></span>
<span><span class="va">Custom_Sig_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#If you already have a Custom_Sig_list</span></span>
<span><span class="va">Custom_Sig_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">custom_dir</span>,<span class="st">"/sig/Custom_Sig_list.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. add signatures to Custom_Sig_list</span></span>
<span><span class="va">Custom_Sig_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Custom_Sig_list</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">Sig</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Custom_Sig_list</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Custom_Sig_list</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="va">Custom_Sig_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Custom_Sig_list</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">id</span></span>
<span></span>
<span><span class="co"># You may delete a certain Sig from the Custom_Sig_list using this code:</span></span>
<span><span class="co"># Custom_Sig_list[[length(Custom_Sig_list)]] = NULL</span></span>
<span></span>
<span><span class="co"># 3. save updated Custom_Sig_list</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">Custom_Sig_list</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">custom_dir</span>,<span class="st">"/sig/Custom_Sig_list.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In the end, you should have a Custom_Sig_list containing elements
like this:</p>
<p align="center">
</p>
<p><img src="../reference/figures/custom_sig_list.jpg" width="500/"></p>

<p>If you have more SCCs, you should have more elements in the
Custom_Sig_list.</p>
</div>
</div>
<div class="section level3">
<h3 id="step-2-prepare-res-obj">Step 2 üìà Prepare res obj<a class="anchor" aria-label="anchor" href="#step-2-prepare-res-obj"></a>
</h3>
<p>Now you should have at least one SCC signature and one AF
signature(necessary for res obj preparation) in the Custom_Sig_list. If
so, we can proceed to prpare res obj for each fluorescence, including
the AF.</p>
<div class="section level4">
<h4 id="step-2-1-read-custom_sig_list-and-prepare-sig_mtx">step 2.1 read Custom_Sig_list and prepare Sig_mtx<a class="anchor" aria-label="anchor" href="#step-2-1-read-custom_sig_list-and-prepare-sig_mtx"></a>
</h4>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Custom_Sig_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">custom_dir</span>,<span class="st">"/sig/Custom_Sig_list.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Sig_info</span> <span class="op">=</span> <span class="fu"><a href="../reference/querySig.html">querySig</a></span><span class="op">(</span>Sig_list <span class="op">=</span> <span class="va">Custom_Sig_list</span><span class="op">)</span></span>
<span><span class="va">fluors_selected</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Sig_info</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fluors_selected</span><span class="op">)</span></span>
<span><span class="va">Sig_mtx</span>  <span class="op">=</span> <span class="fu"><a href="../reference/getSigMtx.html">getSigMtx</a></span><span class="op">(</span>ids <span class="op">=</span> <span class="va">fluors_selected</span>, Sig_list <span class="op">=</span> <span class="va">Custom_Sig_list</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="sc">&gt;</span> fluors_selected</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"SCCcustom_Cell_CD2_SB780"</span> <span class="st">"SCCcustom_Cell_AF_AF"</span> </span></code></pre></div>
<p>Here we need to select all target fluorescence, including AF. The
order do not matter now, since we will assign target index and AF index
later.</p>
</div>
<div class="section level4">
<h4 id="step-2-2-read-scc-fcs">step 2.2 read scc fcs<a class="anchor" aria-label="anchor" href="#step-2-2-read-scc-fcs"></a>
</h4>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/read.FCS.html" class="external-link">read.FCS</a></span><span class="op">(</span><span class="st">"E:/Data/SCC_Cell_CD2_SB780 Run 1 20251024102726.fcs"</span><span class="op">)</span></span>
<span><span class="co"># data = read.FCS("E:/Data/unstained_1 Run 1 20251024100712.fcs") #For AF</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">@</span><span class="va">parameters</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">desc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">@</span><span class="va">parameters</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">desc</span> <span class="op">=</span> <span class="va">data</span><span class="op">@</span><span class="va">parameters</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">desc</span> <span class="co"># "desc" or "name" are used for different insruments. Ues the one with correct detector names.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/exprs.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">=</span> <span class="va">desc</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="step-2-3-set-target-and-af-info">step 2.3 set target and AF info<a class="anchor" aria-label="anchor" href="#step-2-3-set-target-and-af-info"></a>
</h4>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">save_suf</span> <span class="op">=</span> <span class="st">"SCCcustom_Cell_CD2_SB780"</span></span>
<span><span class="va">idx_target_fluor</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">idx_AF_fluor</span> <span class="op">=</span> <span class="fl">2</span></span>
<span></span>
<span><span class="co"># For AF</span></span>
<span><span class="co"># save_suf = "SCCcustom_Cell_AF_AF"</span></span>
<span><span class="co"># idx_target_fluor = 2</span></span>
<span><span class="co"># idx_AF_fluor = 1 #For AF, use any other scc here</span></span>
<span></span>
<span><span class="co">#check if the idx are correct</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">[</span><span class="va">idx_target_fluor</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">[</span><span class="va">idx_AF_fluor</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(<span class="fu">colnames</span>(Sig_mtx))</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"SCCcustom_Cell_CD2_SB780"</span> <span class="st">"SCCcustom_Cell_AF_AF"</span> </span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">colnames</span>(Sig_mtx)[idx_target_fluor]</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"SCCcustom_Cell_CD2_SB780"</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">colnames</span>(Sig_mtx)[idx_AF_fluor]</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"SCCcustom_Cell_AF_AF"</span></span></code></pre></div>
<p>Here we need to choose the index (idx) for target fluorescence and
corresponding AF. For example, we want to prepare res obj for
SCCcustom_Cell_CD2_SB780 first. So we assign the index for
‚ÄúSCCcustom_Cell_CD2_SB780‚Äù as idx_target_fluor. The
‚ÄúSCCcustom_Cell_AF_AF‚Äù is used as corrsponding AF.</p>
<p>If we want to prepare res obj for AF. We can simply assign the index
for the AF as idx_target_fluor, and use any other index as
idx_AF_fluor.</p>
</div>
<div class="section level4">
<h4 id="step-2-4-gate-siglets-and-target-population">step 2.4 gate siglets and target population<a class="anchor" aria-label="anchor" href="#step-2-4-gate-siglets-and-target-population"></a>
</h4>
<p>Here we want to use as many cells as possible to calculate parameters
for the res obj. However, we need to gate required cells first. To speed
up the gating step, we can use a sampled subset to make gates and then
subset from all cells.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. sample cells.</span></span>
<span><span class="co">#You may modify code here to sample specific set for rare markers.</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">gate0</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="va">data_backup</span> <span class="op">=</span> <span class="va">data</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">20000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. gate singlets if need</span></span>
<span><span class="co">#You can change the FSC and SSC names for specific instrument.</span></span>
<span><span class="co"># use colnames(data) to find available paramters</span></span>
<span><span class="co"># colnames(data)</span></span>
<span><span class="va">gate1</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/PolygonGating.html" class="external-link">PolygonGating</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">data</span>, x_col<span class="op">=</span> <span class="st">"488 FSC-A"</span>, y_col<span class="op">=</span> <span class="st">"488 FSC-H"</span>, feature_col<span class="op">=</span> <span class="st">"488 FSC-A"</span>,</span>
<span>                     parentgate_col<span class="op">=</span> <span class="st">"gate0"</span>, newgate_col<span class="op">=</span> <span class="st">"gate1"</span>,canvas_width<span class="op">=</span><span class="fl">800</span>, canvas_height<span class="op">=</span><span class="fl">400</span>,</span>
<span>                     title_text <span class="op">=</span> <span class="st">"Gate singlets"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate1</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">gate2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/PolygonGating.html" class="external-link">PolygonGating</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">data</span>, x_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>, y_col<span class="op">=</span> <span class="st">"488 SSC-H"</span>, feature_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>,</span>
<span>                     parentgate_col<span class="op">=</span> <span class="st">"gate1"</span>, newgate_col<span class="op">=</span> <span class="st">"gate2"</span>,canvas_width<span class="op">=</span><span class="fl">800</span>, canvas_height<span class="op">=</span><span class="fl">400</span>,</span>
<span>                     title_text <span class="op">=</span> <span class="st">"Gate singlets"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate2</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. gate target population (e.g. lymphocytes)</span></span>
<span><span class="va">gate3</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/PolygonGating.html" class="external-link">PolygonGating</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">data</span>, x_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>, y_col<span class="op">=</span> <span class="st">"488 FSC-A"</span>, feature_col<span class="op">=</span> <span class="st">"488 SSC-A"</span>,</span>
<span>                     parentgate_col<span class="op">=</span> <span class="st">"gate2"</span>, newgate_col<span class="op">=</span> <span class="st">"gate3"</span>,canvas_width<span class="op">=</span><span class="fl">1500</span>, canvas_height<span class="op">=</span><span class="fl">1500</span>,</span>
<span>                     title_text <span class="op">=</span> <span class="st">"Gate target population"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate3</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. subset with all cells</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data_backup</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate1</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate2</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate3</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">gate3</span>,<span class="op">]</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_res_gatesiglets_1.jpg" width="500/"></p>

<p align="center">
</p>
<p><img src="../reference/figures/custom_res_gatesiglets_2.jpg" width="500/"></p>

<p align="center">
</p>
<p><img src="../reference/figures/custom_res_gatesiglets_3.jpg" width="500/"></p>

</div>
<div class="section level4">
<h4 id="step-2-5-unmix-with-target_fluor-and-af">step 2.5 unmix with target_fluor and AF<a class="anchor" aria-label="anchor" href="#step-2-5-unmix-with-target_fluor-and-af"></a>
</h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">]</span> <span class="co">#cells x detectors</span></span>
<span><span class="va">R</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="co"># detectors x cells</span></span>
<span><span class="va">A</span> <span class="op">=</span> <span class="va">Sig_mtx</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">idx_target_fluor</span>,<span class="va">idx_AF_fluor</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="co"># detectors x fluors</span></span>
<span><span class="va">A_pinv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/ginv.html" class="external-link">ginv</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="va">B</span> <span class="op">=</span>  <span class="va">A_pinv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">R</span></span>
<span><span class="va">t_B</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">t_B</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">[</span><span class="va">idx_target_fluor</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">[</span><span class="va">idx_AF_fluor</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">data</span>,<span class="va">t_B</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="step-2-6-gate-normal-samples">step 2.6 gate normal samples<a class="anchor" aria-label="anchor" href="#step-2-6-gate-normal-samples"></a>
</h4>
<p>It is common to find outliers or weird populations in SCC sample.
However, we only need stable positive population, with as wide range as
possible. So here we need to gate this normal population that we
need.</p>
<p>High quality data is needed, which means the cells/beads intensity
ranges form low to very high value and covers the estiamted intensity.
Also, it is very important to have enough amount of sample size to have
robust estimation. The higher the more robust, &gt; 10000 cells is
recommended.</p>
<p>If the outlier makes the gating difficult, you may remove outliers
first.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># You may remove some outliers for easier gating</span></span>
<span><span class="co"># data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] &lt;</span></span>
<span><span class="co">#                quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.999)),]</span></span>
<span><span class="co"># data = data[(data[,colnames(Sig_mtx)[idx_target_fluor]] &gt;</span></span>
<span><span class="co">#                quantile(data[,colnames(Sig_mtx)[idx_target_fluor]],0.01)),]</span></span>
<span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">gate0</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="va">data_backup</span> <span class="op">=</span> <span class="va">data</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">20000</span><span class="op">)</span></span>
<span><span class="va">gate_normal</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/GateData/man/PolygonGating.html" class="external-link">PolygonGating</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">data</span>, x_col<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">[</span><span class="va">idx_target_fluor</span><span class="op">]</span>,</span>
<span>                           y_col<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">[</span><span class="va">idx_AF_fluor</span><span class="op">]</span>,</span>
<span>                           feature_col<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">[</span><span class="va">idx_target_fluor</span><span class="op">]</span>,</span>
<span>                           parentgate_col<span class="op">=</span> <span class="st">"gate0"</span>, newgate_col<span class="op">=</span> <span class="st">"gate_normal"</span>,canvas_width<span class="op">=</span><span class="fl">800</span>, canvas_height<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data_backup</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GateData/man/GateDecider.html" class="external-link">GateDecider</a></span><span class="op">(</span>gate <span class="op">=</span> <span class="va">gate_normal</span>, df <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">gate_normal</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#you may save gate_normal is you want</span></span>
<span><span class="co"># saveRDS(list(gate_normal), file = paste0(custom_dir,"/",save_suf,"_gatelist.rds"))</span></span>
<span><span class="co"># saveRDS(c("gate_normal"), file = paste0(custom_dir,"/",save_suf,"_gatenames.rds"))</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_res_gatenromal_CD2.jpg" width="500/"></p>

<p>To gate normal population for AF, we just need to gate a stable
negative populaiton:</p>
<p align="center">
</p>
<p><img src="../reference/figures/custom_res_gatenromal_AF.jpg" width="500/"></p>

</div>
<div class="section level4">
<h4 id="calculate-and-save-residual-model">2.7 calculate and save residual model<a class="anchor" aria-label="anchor" href="#calculate-and-save-residual-model"></a>
</h4>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="va">A_Target</span> <span class="op">=</span> <span class="va">Sig_mtx</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">idx_target_fluor</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="va">A_AF</span> <span class="op">=</span> <span class="va">Sig_mtx</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">idx_AF_fluor</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span><span class="va">ResObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/CreateRes.html">CreateRes</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">[</span><span class="va">idx_target_fluor</span><span class="op">]</span>, R <span class="op">=</span> <span class="va">R</span>, A_Target <span class="op">=</span> <span class="va">A_Target</span>, A_AF <span class="op">=</span> <span class="va">A_AF</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ResObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/SlopEstimation.html">SlopEstimation</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span>, bin_num <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#You may briefly visualize the slope matrix</span></span>
<span><span class="va">col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html" class="external-link">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">ResObj</span><span class="op">$</span><span class="va">slopMtx</span>,col <span class="op">=</span> <span class="va">col_fun</span>, cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>,cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        cell_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">i</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">width</span>, <span class="va">height</span>, <span class="va">fill</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html" class="external-link">grid.text</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="va">ResObj</span><span class="op">$</span><span class="va">slopMtx</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span>, <span class="va">x</span>, <span class="va">y</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span>,column_title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">[</span><span class="va">idx_target_fluor</span><span class="op">]</span>,name <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">ResObj</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">custom_dir</span>,<span class="st">"/res"</span>,<span class="st">"/ResObj_"</span>,<span class="va">save_suf</span>,<span class="st">".rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="sc">&gt;</span> ResObj <span class="ot">=</span> <span class="fu">SlopEstimation</span>(<span class="at">Res =</span> ResObj, <span class="at">bin_num =</span> <span class="dv">30</span>)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>calculating cov matrix...</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>(<span class="sc">-</span>) [<span class="sc">==</span><span class="er">=============================</span>] <span class="dv">100</span>% [Elapsed time<span class="sc">:</span> <span class="dv">00</span><span class="sc">:</span><span class="dv">00</span><span class="sc">:</span><span class="dv">09</span> <span class="sc">||</span> Estimated time remaining<span class="sc">:</span>  0s]</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>calculating slop matrix...</span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_res_slop_CD2.jpg" width="500/"></p>

For AF:
<p align="center">
</p>
<p><img src="../reference/figures/custom_res_slop_AF.jpg" width="500/"></p>

<p>The generated ResObj contains all details, which will be used for
prediction.</p>
<p align="center">
</p>
<p><img src="../reference/figures/custom_res_detail.jpg" width="500/"></p>

</div>
</div>
<div class="section level3">
<h3 id="step-3-use-custom-res-obj-and-built-in-res-obj-together-to-make-spread-prediction">Step 3 Use custom res obj and built-in res obj together to make
spread prediction<a class="anchor" aria-label="anchor" href="#step-3-use-custom-res-obj-and-built-in-res-obj-together-to-make-spread-prediction"></a>
</h3>
<p>Once we have res obj for all custom SCC ready, we can make
prediction!</p>
<p>If you are falimilar with the basic use of USERM, it will be very
easy to adapt it to the custom SCC. So, please try the built-in SCC
first <a href="https://xiangmingcai.github.io/USERM/articles/instruction_basic.html">instruction</a>.</p>
<p>Here we show how to use both custom SCC and built-in SCC together. If
you only use custom SCC, just ignore the code for built-in SCC.</p>
<p>Note: the custom_dir contains following files now:</p>
<pre><code>MyFolder/
‚îú‚îÄ‚îÄ res/                  
‚îÇ   ‚îú‚îÄ‚îÄ ResObj_SCCcustom_Cell_AF_AF.rds          
‚îÇ   ‚îî‚îÄ‚îÄ ResObj_SCCcustom_Cell_CD2_SB780.rds
‚îú‚îÄ‚îÄ sig/                  
‚îÇ   ‚îî‚îÄ‚îÄ Custom_Sig_list.rds</code></pre>
<p>Remember to keep these files, so that you do not need to generate
them again next time!</p>
<div class="section level4">
<h4 id="step-3-1-check-available-custom-fluorescence">step 3.1 check available custom fluorescence<a class="anchor" aria-label="anchor" href="#step-3-1-check-available-custom-fluorescence"></a>
</h4>
<p>First, read in the Custom_Sig_list.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Custom_Sig_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">custom_dir</span>,<span class="st">"/sig/Custom_Sig_list.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Custom_Sig_info</span> <span class="op">=</span> <span class="fu"><a href="../reference/querySig.html">querySig</a></span><span class="op">(</span>Sig_list <span class="op">=</span> <span class="va">Custom_Sig_list</span><span class="op">)</span></span>
<span><span class="va">fluor_to_check</span> <span class="op">=</span> <span class="va">Custom_Sig_info</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fluor_to_check</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/checkSig_linePlot.html">checkSig_linePlot</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">fluor_to_check</span>, Sig_list <span class="op">=</span> <span class="va">Custom_Sig_list</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(fluor_to_check)</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"SCCcustom_Cell_CD2_SB780"</span></span></code></pre></div>
<p>You can check the signature of fluorescence of interest.</p>
<p>You can also check the res obj of interested fluorescence.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#get Residual Obj</span></span>
<span><span class="va">ResObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/getRes.html">getRes</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">fluor_to_check</span>,custom_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">custom_dir</span>,<span class="st">"/res"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/checkRes_slopMtx.html">checkRes_slopMtx</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/checkRes_interceptMtx.html">checkRes_interceptMtx</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ResObj</span><span class="op">$</span><span class="va">bin_mids</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/checkRes_covMtx.html">checkRes_covMtx</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span>,bin<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">ResObj</span><span class="op">$</span><span class="va">detectors</span></span>
<span><span class="fu"><a href="../reference/checkRes_covScatter.html">checkRes_covScatter</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span>,</span>
<span>                    detector1 <span class="op">=</span> <span class="va">ResObj</span><span class="op">$</span><span class="va">detectors</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                    detector2 <span class="op">=</span> <span class="va">ResObj</span><span class="op">$</span><span class="va">detectors</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="step-3-2-select-fluors-and-create-usermobj">step 3.2 Select fluors and create UsermObj<a class="anchor" aria-label="anchor" href="#step-3-2-select-fluors-and-create-usermobj"></a>
</h4>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Custom_fluors_selected</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Custom_Sig_info</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Custom_fluors_selected</span><span class="op">)</span></span>
<span><span class="va">Custom_Sig_mtx</span>  <span class="op">=</span> <span class="fu"><a href="../reference/getSigMtx.html">getSigMtx</a></span><span class="op">(</span>ids <span class="op">=</span> <span class="va">Custom_fluors_selected</span>,Sig_list <span class="op">=</span> <span class="va">Custom_Sig_list</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Custom_Sig_mtx</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(Custom_fluors_selected)</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"SCCcustom_Cell_CD2_SB780"</span> <span class="st">"SCCcustom_Cell_AF_AF"</span> </span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">dim</span>(Custom_Sig_mtx)</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">51</span>  <span class="dv">2</span></span></code></pre></div>
<p>If you want to use some built-in fluorescence, you can select them as
well.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">builtin_Sig_info</span> <span class="op">=</span> <span class="fu"><a href="../reference/querySig.html">querySig</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">builtin_fluors_selected</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">builtin_Sig_info</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">34</span>,<span class="fl">35</span>,<span class="fl">36</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">builtin_fluors_selected</span><span class="op">)</span></span>
<span><span class="va">builtin_Sig_mtx</span>  <span class="op">=</span> <span class="fu"><a href="../reference/getSigMtx.html">getSigMtx</a></span><span class="op">(</span>ids <span class="op">=</span> <span class="va">builtin_fluors_selected</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">builtin_Sig_mtx</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(builtin_fluors_selected)</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"SCC_Cell_CD3_BV510"</span>  <span class="st">"SCC_Cell_CD4_NFR700"</span> <span class="st">"SCC_Cell_CD8_BV570"</span> </span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">dim</span>(builtin_Sig_mtx)</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">51</span>  <span class="dv">3</span></span></code></pre></div>
<p>Now we can bind these 2 Sig_mtx, and add res obj to UsermObj one by
one.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sig_mtx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">builtin_Sig_mtx</span>,<span class="va">Custom_Sig_mtx</span><span class="op">)</span></span>
<span></span>
<span><span class="va">UsermObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/CreateUserm.html">CreateUserm</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">Sig_mtx</span><span class="op">)</span></span>
<span><span class="co">#add ResObj into UsermObj</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">save_suf</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">builtin_Sig_mtx</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ResObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/getRes.html">getRes</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">save_suf</span><span class="op">)</span></span>
<span>  <span class="va">UsermObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/AddRes2Userm.html">AddRes2Userm</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span>, Userm <span class="op">=</span> <span class="va">UsermObj</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">save_suf</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Custom_Sig_mtx</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ResObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/getRes.html">getRes</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">save_suf</span>,custom_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">custom_dir</span>,<span class="st">"/res"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">UsermObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/AddRes2Userm.html">AddRes2Userm</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span>, Userm <span class="op">=</span> <span class="va">UsermObj</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="step-3-3-prediction">step 3.3 prediction<a class="anchor" aria-label="anchor" href="#step-3-3-prediction"></a>
</h4>
<p>Prediction is the same as the basic use. Here we show some simple
case. You can explore more when your data is ready.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/PredOneSpread.html">PredOneSpread</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span>,population_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P1"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_predict_1.jpg" width="500/"></p>

<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P1"</span>,<span class="st">"P2"</span>,<span class="st">"P3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/PredMultipleSpread.html">PredMultipleSpread</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span>,population_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P1"</span>,<span class="st">"P2"</span>,<span class="st">"P3"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_predict_2.jpg" width="500/"></p>

<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Coef_mtx</span> <span class="op">=</span> <span class="fu"><a href="../reference/EstimateCoefMtx.html">EstimateCoefMtx</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/Vis_Mtx.html">Vis_Mtx</a></span><span class="op">(</span>mat <span class="op">=</span> <span class="va">Coef_mtx</span>,mincolor <span class="op">=</span> <span class="st">"white"</span>,midcolor <span class="op">=</span> <span class="st">"white"</span>, maxcolor <span class="op">=</span> <span class="st">"#95ABDB"</span>,</span>
<span>        max <span class="op">=</span> <span class="fl">20</span>,mid <span class="op">=</span> <span class="fl">10</span>,min <span class="op">=</span> <span class="fl">0</span>,legend_name <span class="op">=</span> <span class="st">"Coef"</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Coefficient of residual model matrix (Coef Matrix) (row spread into column)"</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_predict_3.jpg" width="500/"></p>

<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Hotspot_mtx</span> <span class="op">=</span> <span class="fu"><a href="../reference/EstimateHotspotMtx.html">EstimateHotspotMtx</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">UsermObj</span><span class="op">$</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/Vis_Mtx.html">Vis_Mtx</a></span><span class="op">(</span>mat <span class="op">=</span> <span class="va">Hotspot_mtx</span>,mincolor <span class="op">=</span> <span class="st">"white"</span>,midcolor <span class="op">=</span> <span class="st">"white"</span>, maxcolor <span class="op">=</span> <span class="st">"#95ABDB"</span>,</span>
<span>        max <span class="op">=</span> <span class="fl">2</span>,mid <span class="op">=</span> <span class="fl">1</span>,min <span class="op">=</span> <span class="fl">0</span>,legend_name <span class="op">=</span> <span class="st">"Hotspot"</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Hotspot matrix"</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_predict_4.jpg" width="500/"></p>

<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Similarity_mtx</span> <span class="op">=</span> <span class="fu"><a href="../reference/EstimateSimilarityMtx.html">EstimateSimilarityMtx</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">UsermObj</span><span class="op">$</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/Vis_Mtx.html">Vis_Mtx</a></span><span class="op">(</span>mat <span class="op">=</span> <span class="va">Similarity_mtx</span>,mincolor <span class="op">=</span> <span class="st">"white"</span>,midcolor <span class="op">=</span> <span class="st">"white"</span>, maxcolor <span class="op">=</span> <span class="st">"#95ABDB"</span>,</span>
<span>        max <span class="op">=</span> <span class="fl">1</span>,mid <span class="op">=</span> <span class="fl">0.8</span>,min <span class="op">=</span> <span class="fl">0</span>,legend_name <span class="op">=</span> <span class="st">"Cosine"</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Cosine similarity matrix"</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/custom_predict_5.jpg" width="500/"></p>

</div>
</div>
<div class="section level3">
<h3 id="citation">üìö Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h3>
<p>If you use this package in your research, please cite our paper and
the package as:</p>
<pre><code>Xiangming Cai, Sara Garcia-Garcia, Nick Rohrbacker, Michaela Gianniou, Juan J. Garcia Vallejo. Manuscript in preparation. (to be update)

Cai X (2025). _USERM: Unmixing Spread Estimation with Residual Model_. R package version
  1.0.0,  &lt;https://github.com/xiangmingcai/USERM&gt;.
  
@Manual{,
    title = {USERM: Unmixing Spread Estimation with Residual Model},
    author = {Xiangming Cai},
    year = {2025},
    note = {R package version 1.0.0},
    url = {https://github.com/xiangmingcai/USERM},
  }</code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/xiangmingcai" class="external-link">Xiangming Cai</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>

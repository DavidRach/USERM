<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Basic Instruction ‚Ä¢ USERM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Basic Instruction">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">USERM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/instruction_basic.html">Basic Instruction</a></li>
    <li><a class="dropdown-item" href="../articles/instruction_customFCS.html">Use Custom SCC</a></li>
    <li><a class="dropdown-item" href="../articles/instruction_interprateHighCoef.html">Interprate Spread</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/xiangmingcai/USERM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Basic Instruction</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/xiangmingcai/USERM/blob/HEAD/vignettes/instruction_basic.Rmd" class="external-link"><code>vignettes/instruction_basic.Rmd</code></a></small>
      <div class="d-none name"><code>instruction_basic.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="basic-instruction-for-userm-use">Basic instruction for USERM use<a class="anchor" aria-label="anchor" href="#basic-instruction-for-userm-use"></a>
</h2>
<p>Xiangming Cai</p>
<p>2025-11-22</p>
<div class="section level3">
<h3 id="introduction">üîç Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>The USERM provides an out-of-box tool to apply the residual model
approach <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Xiangming Cai, Sara Garcia-Garcia, Nick Rohrbacker,
Michaela Gianniou, Juan J. Garcia Vallejo. Manuscript in preparation.&lt;/p&gt;"><sup>1</sup></a>, which characterizes and predicts the
spread of unmixed spectral flow cytometry data, which arises from
instrumental noise or deviations between actual cellular emission and
the average fluorescence signatures.</p>
<p>The USERM also supports computing various matrixes tools for panel
design, including the Coef Matrix, the Hotspot Matrix, and the
Similarity Matrix, and many others.</p>
</div>
<div class="section level3">
<h3 id="installation">üíª Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>You can install the development version of USERM from <a href="https://github.com/xiangmingcai/USERM" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"xiangmingcai/USERM"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-1-query-avalilable-fluorescence-list">Step 1 üìà query avalilable fluorescence list<a class="anchor" aria-label="anchor" href="#step-1-query-avalilable-fluorescence-list"></a>
</h3>
<p>You can use querySig function to query all available
fluorescence.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://xiangmingcai.github.io/USERM">USERM</a></span><span class="op">)</span></span>
<span><span class="va">Sig_info</span> <span class="op">=</span> <span class="fu"><a href="../reference/querySig.html">querySig</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Sig_info</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">head</span>(Sig_info)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>                    id PrimaryName SecondaryName detectors instrument       Source Note</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="dv">1</span>  SCC_Bead_CD4_NFR700         CD4        NFR700        <span class="dv">51</span>     Xenith XiangmingCai   <span class="cn">NA</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="dv">2</span>   SCC_Bead_CD3_BV510         CD3         BV510        <span class="dv">51</span>     Xenith XiangmingCai   <span class="cn">NA</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="dv">3</span>    SCC_Bead_CD2_FITC         CD2          FITC        <span class="dv">51</span>     Xenith XiangmingCai   <span class="cn">NA</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="dv">4</span>       SCC_Bead_AF_AF          AF            AF        <span class="dv">51</span>     Xenith XiangmingCai   <span class="cn">NA</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="dv">5</span>   SCC_Bead_CD8_BV570         CD8         BV570        <span class="dv">51</span>     Xenith XiangmingCai   <span class="cn">NA</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="dv">6</span> SCC_Bead_CD16_BUV805        CD16        BUV805        <span class="dv">51</span>     Xenith XiangmingCai   <span class="cn">NA</span></span></code></pre></div>
<p>To check signature of a specific fluroescence, you may</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fluor_to_check</span> <span class="op">=</span> <span class="va">Sig_info</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fluor_to_check</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/checkSig_linePlot.html">checkSig_linePlot</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">fluor_to_check</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(fluor_to_check)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"SCC_Bead_CD2_FITC"</span></span></code></pre></div>
<p><img src="../reference/figures/checkSig_linePlot.jpg" width="500"></p>
<p>These available fluorescence were preprocessed with parameters
extracted for residual model. To access the corresponding residaul model
and its parameters, you can use the getRes function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ResObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/getRes.html">getRes</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">fluor_to_check</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/ResObj.jpg" width="500"></p>
<p>The ResObj Object contains all relavant informations. If you are
interested, please read our paper (mentioned on the top) to know the
concepts of each matrix shown here. See <a href="https://xiangmingcai.github.io/USERM/reference/CreateRes.html">CreateRes</a>
and <a href="https://xiangmingcai.github.io/USERM/reference/SlopEstimation.html">SlopEstimation</a>
for detailed introduction of the structure of ResObj.</p>
<p>You can easily visaulize all these matrixes, when you are interested
in any one of them.</p>
<p>To check the slop matrix:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/checkRes_slopMtx.html">checkRes_slopMtx</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/slopmtx.jpg" width="500"></p>
<p>To check the intercept matrix:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/checkRes_interceptMtx.html">checkRes_interceptMtx</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/interceptmtx.jpg" width="500"></p>
<p>You can check the covariance matrix at a specified fluorescence
intensity (bin):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ResObj</span><span class="op">$</span><span class="va">bin_mids</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/checkRes_covMtx.html">checkRes_covMtx</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span>,bin<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/covmtx.jpg" width="500"></p>
<p>You can even check the linear fitting of covariance versus
fluorescence intensity (bin) between two speific detectors:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ResObj</span><span class="op">$</span><span class="va">detectors</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/checkRes_covScatter.html">checkRes_covScatter</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span>,</span>
<span>                    detector1 <span class="op">=</span> <span class="va">ResObj</span><span class="op">$</span><span class="va">detectors</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                    detector2 <span class="op">=</span> <span class="va">ResObj</span><span class="op">$</span><span class="va">detectors</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/covscatter.jpg" width="500"></p>
</div>
<div class="section level3">
<h3 id="step-2-select-and-rename-fluors-and-create-suprobj">Step 2 üñä Select and rename fluors and create SuprObj<a class="anchor" aria-label="anchor" href="#step-2-select-and-rename-fluors-and-create-suprobj"></a>
</h3>
<p>You may now select fluorescence to make a panel. Of note, the targets
(e.g.¬†CD3, CD4) do not matter here, only the fluorescence matches. That
means if you plan to use FITC-CD4 in you panel, you can use FITC-CD2 in
the USERM to make estimation and prediction. If the fluorescence that
you need were not available in the USERM, you can prepare single color
control FCS file yourself and process it following this custom <a href="https://xiangmingcai.github.io/USERM/articles/instruction_customFCS.html">instruction</a>.</p>
<p>Assume all fluorescence that you need is available, now you can
select them out:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fluors_selected</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Sig_info</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span><span class="op">:</span><span class="fl">34</span>,<span class="fl">63</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">fluors_selected</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="sc">&gt;</span> fluors_selected</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"SCC_Cell_LD_LDNIR876"</span> <span class="st">"SCC_Cell_CD2_FITC"</span>    <span class="st">"SCC_Cell_CD3_BV510"</span>   <span class="st">"SCC_Cell_AF_AF"</span>   </span></code></pre></div>
<p>Here we select 3 fluorescence plus autofluorescence (AF) to make a
simple panel. If you expecting more (&gt;40), just select all of them.
Notely, both SCC Cells and Beads are using together. Based on our
research, it is ok to use SCC beads for prediction.</p>
<p>Now, we can create the signature matrix of selected fluorescence</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sig_mtx</span>  <span class="op">=</span> <span class="fu"><a href="../reference/getSigMtx.html">getSigMtx</a></span><span class="op">(</span>ids <span class="op">=</span> <span class="va">fluors_selected</span><span class="op">)</span> <span class="co">#(detectors x fluorescence)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">dim</span>(Sig_mtx)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">51</span> <span class="dv">4</span></span></code></pre></div>
<p>Then, we create a UsermObj to contain all ResObj.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">UsermObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/CreateUserm.html">CreateUserm</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">Sig_mtx</span><span class="op">)</span></span>
<span><span class="co">#add ResObj into UsermObj</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">save_suf</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Sig_mtx</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ResObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/getRes.html">getRes</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">save_suf</span><span class="op">)</span></span>
<span>  <span class="va">UsermObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/AddRes2Userm.html">AddRes2Userm</a></span><span class="op">(</span>Res <span class="op">=</span> <span class="va">ResObj</span>, Userm <span class="op">=</span> <span class="va">UsermObj</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="../reference/figures/UsermObj.jpg" width="500"></p>
<p>The UsermObj contains all information needed for prediction. The Res
item is a list with ResObj of each fluorescence. The Scale_df item
contains the scale setting for visualization afterward. It is ok to
leave it as NA. Default linear scale will be applied (Options: ‚ÄúLinear‚Äù,
‚ÄúLog10‚Äù, ‚ÄúArcsinh‚Äù). The Intensity_mtx contains the estimated
fluorescence intensities of cell populations. In the example shown here,
we have one default populaiton named ‚ÄúP1‚Äù. You can modify the name or
intensities or add new populations for interactive prediction in Step
3.</p>
<p>If you hope to rename the fluorescence, you can do this now:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">UsermObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/RenameFluor.html">RenameFluor</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span>,raw_name <span class="op">=</span> <span class="st">"SCC_Cell_LD_LDNIR876"</span>,new_name <span class="op">=</span> <span class="st">"LiveDead"</span><span class="op">)</span></span>
<span><span class="va">UsermObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/RenameFluor.html">RenameFluor</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span>,raw_name <span class="op">=</span> <span class="st">"SCC_Cell_CD2_FITC"</span>,new_name <span class="op">=</span> <span class="st">"CD2_FITC"</span><span class="op">)</span></span>
<span><span class="va">UsermObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/RenameFluor.html">RenameFluor</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span>,raw_name <span class="op">=</span> <span class="st">"SCC_Cell_CD3_BV510"</span>,new_name <span class="op">=</span> <span class="st">"CD3_BV510"</span><span class="op">)</span></span>
<span><span class="va">UsermObj</span> <span class="op">=</span> <span class="fu"><a href="../reference/RenameFluor.html">RenameFluor</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span>,raw_name <span class="op">=</span> <span class="st">"SCC_Cell_AF_AF"</span>,new_name <span class="op">=</span> <span class="st">"AF"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="sc">&gt;</span> UsermObj <span class="ot">=</span> <span class="fu">RenameFluor</span>(<span class="at">Userm =</span> UsermObj,<span class="at">raw_name =</span> <span class="st">"SCC_Cell_LD_LDNIR876"</span>,<span class="at">new_name =</span> <span class="st">"LiveDead"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>Successfully renamed SCC_Cell_LD_LDNIR876 as LiveDead</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="sc">&gt;</span> UsermObj <span class="ot">=</span> <span class="fu">RenameFluor</span>(<span class="at">Userm =</span> UsermObj,<span class="at">raw_name =</span> <span class="st">"SCC_Cell_CD2_FITC"</span>,<span class="at">new_name =</span> <span class="st">"CD2_FITC"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>Successfully renamed SCC_Cell_CD2_FITC as CD2_FITC</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="sc">&gt;</span> UsermObj <span class="ot">=</span> <span class="fu">RenameFluor</span>(<span class="at">Userm =</span> UsermObj,<span class="at">raw_name =</span> <span class="st">"SCC_Cell_CD3_BV510"</span>,<span class="at">new_name =</span> <span class="st">"CD3_BV510"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>Successfully renamed SCC_Cell_CD3_BV510 as CD3_BV510</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="sc">&gt;</span> UsermObj <span class="ot">=</span> <span class="fu">RenameFluor</span>(<span class="at">Userm =</span> UsermObj,<span class="at">raw_name =</span> <span class="st">"SCC_Cell_AF_AF"</span>,<span class="at">new_name =</span> <span class="st">"AF"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>Successfully renamed SCC_Cell_AF_AF as AF  </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-make-prediction-optional">Step 3 üßÆ Make prediction (optional)<a class="anchor" aria-label="anchor" href="#step-3-make-prediction-optional"></a>
</h3>
<p>We can now interactively predict spread with residual model, which
accounts for instrumental noise and deviations between actual cellular
emission and the average fluorescence signatures.</p>
<p>To predict for one population:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/PredOneSpread.html">PredOneSpread</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span>,population_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P1"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/prediction_1.jpg" width="500"></p>
<p>You will see a pop-out shinyapp window.</p>
<p><img src="../reference/figures/prediction_2.jpg" width="500"></p>
<p>The left panel allows users to interactively select and un-select
fluroescence and detectors, and modify intensities. So that users can
flexibly explore the impact of fluorescence combination and intensities
on the predicted spread. Of note, you can use set-all button to adjust
all intensities together. This can be handy when you want to set all of
them as 0 except one fluorescence, in which case you are simulating a
SCC sample.</p>
<p><img src="../reference/figures/prediction_3.jpg" width="500"></p>
<p>The right panel have some tabs. The signature matrix contains all
normalized signatures. If you want to adjust the color threshold, you
may scroll down to the bottom and set new color threshold. There are tow
ways to use different color palette. First, you can get the matrix with
mathods described in Step1 or Step4, and visualize with the Vis_Mtx
function, which is also described in Step4. Another method is that you
can directly copy and paste the whole matrix into Excel and apply
distinct color palette in Excel or other software.</p>
<p><img src="../reference/figures/prediction_4.jpg" width="500"></p>
<p>In the prediction tab, you will see a scatter plot visualizing the
95% range of predicted spread. Two display mode is supported:
<strong><em>Pseudo-color</em></strong> and
<strong><em>Counter-line</em></strong>. It allows the selection of
fluorescence for x and y axes. You can also adjsut the display limis of
the axes. Scale is support with <strong><em>Linear</em></strong>,
<strong><em>Log10</em></strong> and <strong><em>Arcsinh</em></strong>
options. For Arcsinh, users need to set a cofactor.</p>
<p><img src="../reference/figures/af_factor.jpg" width="1000"></p>
<p>Of note, you can now set the <strong><em>Factor for default
Autofluorescence</em></strong> to control the displayed spread from AF.
the displayed spread will be multiplied with the (factor / 100). So,
when the factor is set to 100, the estimated spread from AF will be
displayed completely. If the factor is set to 0, the spread from AF will
be removed. This helps to check only the spread from noise.</p>
<p><img src="../reference/figures/prediction_5.jpg" width="500"></p>
<p>The pinv matrix shows the pseudo-inverse of the signature matrix.</p>
<p><img src="../reference/figures/prediction_6.jpg" width="500"></p>
<p>In the intercept matrix tab, you can check the intercept matrix of
each SCC.</p>
<p><img src="../reference/figures/prediction_7.jpg" width="500"></p>
<p>The summary intercept matrix for each SCC is calculated as
<img src="../reference/figures/function1.jpg" width="100/"> The median value
of all summary intercept matrixes is used in the prediction (last two
rows).</p>
<p><img src="../reference/figures/prediction_8.jpg" width="500"></p>
<p>In the slop matrix tab, you can check the slop matrix of each
fluroescence.</p>
<p><img src="../reference/figures/prediction_9.jpg" width="500"></p>
<p>Similarly, The summary slop matrix for each fluorescence is
calculated as <img src="../reference/figures/function2.jpg" width="100/"> The
summed value of all weighted slop matrixes is used in the prediction
(last two rows).</p>
<p align="center">
</p>
<p><img src="../reference/figures/prediction_82.jpg" width="500/"></p>

<p>To check the detail of each number summary slop matrix, you can use
the weighted tab. Select the fluorescence and the channels to be spread
into, you can check the weighted slop matrix. The sum of the weighted
slop matrix will be the corresponding value in the summary slop matrix.
With the weighted slop matrix, you can explain why a severe spread
occurs.</p>
<p align="center">
</p>
<p><img src="../reference/figures/prediction_10.jpg" width="500/"></p>

<p>In the export tab, you may directly download a complete report of all
the matrixes. You may also export the N-by-N or N-by-1 plots, which
could be quite big for a big panel. If you want to plot the N-by-N or
N-by-1 plots with custom plot setting, you need to assign corresponding
values to the UsermObj[[‚ÄúScale_df‚Äù]]. Otherwise, default setting will be
used.</p>
<p>Prediction for more than one population is possible. However, users
need to set the intensities of populations in advance. Here we predict 3
populations together.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="fl">200</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">UsermObj</span><span class="op">$</span><span class="va">fluors</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="fl">300</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">UsermObj</span><span class="op">$</span><span class="va">fluors</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">UsermObj</span><span class="op">$</span><span class="va">Intensity_mtx</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P1"</span>,<span class="st">"P2"</span>,<span class="st">"P3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/PredMultipleSpread.html">PredMultipleSpread</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span>,population_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P1"</span>,<span class="st">"P2"</span>,<span class="st">"P3"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/prediction_11.jpg" width="500/"></p>

<p>All 3 populations will be shown together in the scatter plot. The
design and the interactive web is similar to that for PredOneSpread
function.</p>
</div>
<div class="section level3">
<h3 id="step-4-matrics-estimation-and-visualization">Step 4 matrics estimation and visualization<a class="anchor" aria-label="anchor" href="#step-4-matrics-estimation-and-visualization"></a>
</h3>
<p>The USERM supports multiple matrix tools for panel design, including
the Coefficient Matrix, the Hotspot Matrix, and the Similarity Matrix,
and the Spread Distance Matrix. All matrix can be visualized with the
<strong><em>Vis_Mtx</em></strong> function.</p>
<p>To estimate a Coefficient Matrix:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Coef_mtx</span> <span class="op">=</span> <span class="fu"><a href="../reference/EstimateCoefMtx.html">EstimateCoefMtx</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/Vis_Mtx.html">Vis_Mtx</a></span><span class="op">(</span>mat <span class="op">=</span> <span class="va">Coef_mtx</span>,mincolor <span class="op">=</span> <span class="st">"white"</span>,midcolor <span class="op">=</span> <span class="st">"white"</span>, maxcolor <span class="op">=</span> <span class="st">"#95ABDB"</span>,</span>
<span>        max <span class="op">=</span> <span class="fl">2</span>,mid <span class="op">=</span> <span class="fl">1</span>,min <span class="op">=</span> <span class="fl">0</span>,legend_name <span class="op">=</span> <span class="st">"Coef"</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Coefficient of residual model matrix (Coef Matrix) (row spread into column)"</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/matrix_1.jpg" width="500/"></p>

<p>In the Coefficient Matrix, a high coef number indicates high
increasing trend of spread from one fluorescence (row) into another
fluorescence (column), following the increase of fluorescence intensity.
To interpret a high observed coef number and its related severe spread,
researchers can use PredOneSpread function to look for the underlying
mechanical explanation and potential solutions. A detailed example is
provided in another <a href="https://xiangmingcai.github.io/USERM/articles/instruction_interprateHighCoef.html">instruction</a>.</p>
<p>There is no specific threshold for ‚Äúbad‚Äù coef number or ‚Äúgood‚Äù coef
number. Because the fluorescence intensity also matters and it varies in
different settings and conjugated targets. However, this Coef Matrix
provides an approach to compare the estimated spread between panels. So
that users can choose a panel with less expected spread.</p>
<p>To estimate a Hotspot Matrix, only the signature matrix A is
required:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Hotspot_mtx</span> <span class="op">=</span> <span class="fu"><a href="../reference/EstimateHotspotMtx.html">EstimateHotspotMtx</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">UsermObj</span><span class="op">$</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/Vis_Mtx.html">Vis_Mtx</a></span><span class="op">(</span>mat <span class="op">=</span> <span class="va">Hotspot_mtx</span>,mincolor <span class="op">=</span> <span class="st">"white"</span>,midcolor <span class="op">=</span> <span class="st">"white"</span>, maxcolor <span class="op">=</span> <span class="st">"#95ABDB"</span>,</span>
<span>        max <span class="op">=</span> <span class="fl">2</span>,mid <span class="op">=</span> <span class="fl">1</span>,min <span class="op">=</span> <span class="fl">0</span>,legend_name <span class="op">=</span> <span class="st">"Hotspot"</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Hotspot matrix"</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/matrix_2.jpg" width="500"></p>

<p>Based on the paper from Mage PL and et al.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Mage PL, Konecny AJ, Mair F. Measurement and prediction
of unmixing-dependent spreading in spectral flow cytometry panels.
bioRxiv [Preprint]. 2025. doi: 10.1101/2025.04.17.649396.&lt;/p&gt;"><sup>2</sup></a>, The diagonal entries
of the Hotspot matrix are informative, as they reflect the degree to
which each fluorescence contributes to unmixing-dependent spread.</p>
<p>To estimate a Similarity Matrix, only the signature matrix A is
required:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Similarity_mtx</span> <span class="op">=</span> <span class="fu"><a href="../reference/EstimateSimilarityMtx.html">EstimateSimilarityMtx</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">UsermObj</span><span class="op">$</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/Vis_Mtx.html">Vis_Mtx</a></span><span class="op">(</span>mat <span class="op">=</span> <span class="va">Similarity_mtx</span>,mincolor <span class="op">=</span> <span class="st">"white"</span>,midcolor <span class="op">=</span> <span class="st">"white"</span>, maxcolor <span class="op">=</span> <span class="st">"#95ABDB"</span>,</span>
<span>        max <span class="op">=</span> <span class="fl">1</span>,mid <span class="op">=</span> <span class="fl">0.8</span>,min <span class="op">=</span> <span class="fl">0</span>,legend_name <span class="op">=</span> <span class="st">"Cosine"</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Cosine similarity matrix"</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/matrix_3.jpg" width="500"></p>

<p>For similarity matrix, a number higher than 0.98 indicates that
signals from the pair of fluorescence cannot be well separated. So, one
of them needs to be replaced by other fluorescence.</p>
<p>It is also possible to estimate the Spread Distance Matrix between
two populations with estimated fluorescence intensities:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Spr1</span> <span class="op">=</span> <span class="fu"><a href="../reference/EstimateSpread.html">EstimateSpread</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span>,population_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P1"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Spr2</span> <span class="op">=</span> <span class="fu"><a href="../reference/EstimateSpread.html">EstimateSpread</a></span><span class="op">(</span>Userm <span class="op">=</span> <span class="va">UsermObj</span>,population_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">SpreadDistance_mtx</span> <span class="op">=</span> <span class="fu"><a href="../reference/EstimateDistance.html">EstimateDistance</a></span><span class="op">(</span><span class="va">Spr1</span>, <span class="va">Spr2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/Vis_Mtx.html">Vis_Mtx</a></span><span class="op">(</span>mat <span class="op">=</span> <span class="va">SpreadDistance_mtx</span>,mincolor <span class="op">=</span> <span class="st">"darkred"</span>,midcolor <span class="op">=</span> <span class="st">"white"</span>, maxcolor <span class="op">=</span> <span class="st">"white"</span>,max <span class="op">=</span> <span class="fl">1.5</span>,mid <span class="op">=</span> <span class="fl">1</span>,min <span class="op">=</span> <span class="fl">0</span>,title <span class="op">=</span> <span class="st">"Spread Distance matrix"</span><span class="op">)</span></span></code></pre></div>
<p align="center">
</p>
<p><img src="../reference/figures/matrix_4.jpg" width="500/"></p>

<p>For the Spread Distance matrix, a value &lt; 1.0 indicates low
resolution between these two cell populations. Of note, this results
only accounts for spread, which originates from instrumental noise or
deviations between actual cellular emission and the average fluorescence
signatures. Also, it only holds for the given fluorescence
intensities.</p>
</div>
<div class="section level3">
<h3 id="citation">üìö Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h3>
<p>If you use this package in your research, please cite our paper and
the package as:</p>
<pre><code>Xiangming Cai, Sara Garcia-Garcia, Nick Rohrbacker, Michaela Gianniou, Juan J. Garcia Vallejo. Manuscript in preparation. (to be update)

Cai X (2025). _USERM: Unmixing Spread Estimation with Residual Model_. R package version
  1.0.0,  &lt;https://github.com/xiangmingcai/USERM&gt;.
  
@Manual{,
    title = {USERM: Unmixing Spread Estimation with Residual Model},
    author = {Xiangming Cai},
    year = {2025},
    note = {R package version 1.0.0},
    url = {https://github.com/xiangmingcai/USERM},
  }</code></pre>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/xiangmingcai" class="external-link">Xiangming Cai</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
